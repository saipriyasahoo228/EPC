import{r as n,j as e,T as M,J as A,E as z,S as L,I as u,K as R}from"./main-Skim5IJC.js";import{C as oe}from"./Close-BKZ7QrSY.js";import{D as ae}from"./Download-C4sxsXoP.js";import{E as ie,a as ce}from"./jspdf.plugin.autotable-Aj3tGQhx.js";import{f as le,s as de,x as N,y as xe,z as pe,A as me,B as ue}from"./construction-CMO2W9OH.js";import{f as Y}from"./date-DdrLtg20.js";import{G as i}from"./Grid-fY_ATwTx.js";import{T as O,a as W,b as S,c as r,d as $}from"./TableRow-B6k_bSOs.js";import{A as je}from"./AddCircle-CJp4DZj3.js";import{B as T,D as he,a as fe,b as ge,c as ye}from"./DialogTitle-CvDFHAwp.js";import{T as _e}from"./TableContainer-gCCy6yK7.js";import{E as Se}from"./Edit-6vcT2Cu4.js";import{D as be}from"./Delete-Be1vvbhC.js";import{M as Ce,a as Ee}from"./minimize-2-RCuvNn0X.js";const Re=()=>{const j="construction",[x,G]=n.useState([]),[b,H]=n.useState([]),[h,C]=n.useState([]),[f,J]=n.useState(""),[g,U]=n.useState(""),[q,E]=n.useState(!1),[F,K]=n.useState(!1),[y,v]=n.useState(!1),[k,D]=n.useState(null),[w,P]=n.useState(""),[o,p]=n.useState({expense_type:"",project:"",safety_management:"",amount:"",description:"",date_incurred:""}),X=()=>K(t=>!t),_=()=>{E(!1),v(!1),D(null),p({expense_type:"",project:"",safety_management:"",amount:"",description:"",date_incurred:""})};n.useEffect(()=>{(async()=>{try{const[t,s,a]=await Promise.all([le(),de(),N()]);G(t||[]),H(s||[]),C(a||[])}catch(t){console.error("❌ Error loading safety expense deps:",t)}})()},[]);const Q=n.useMemo(()=>{if(!f)return x;const t=f.toLowerCase();return(x||[]).filter(s=>[s.project,s.project_name,s.project_status,s.location].filter(Boolean).some(a=>a.toString().toLowerCase().includes(t)))},[x,f]),V=n.useMemo(()=>{if(!g)return h;const t=g.toLowerCase();return(h||[]).filter(s=>[s.expense_type,s.project,s.safety_management,s.amount,s.description,s.date_incurred].filter(Boolean).some(a=>a.toString().toLowerCase().includes(t)))},[h,g]),Z=n.useMemo(()=>w?(b||[]).filter(t=>String(t.project)===String(w)):b,[b,w]),ee=t=>{P(t||""),v(!1),D(null),p({expense_type:"",project:t||"",safety_management:"",amount:"",description:"",date_incurred:""}),E(!0)},te=async t=>{try{const s=await xe(t.id);v(!0),D(t.id),P(s.project||""),p({expense_type:s.expense_type||"",project:s.project||"",safety_management:s.safety_management||"",amount:String(s.amount||""),description:s.description||"",date_incurred:(s.date_incurred||"").slice(0,10)}),E(!0)}catch(s){console.error("❌ Failed to fetch expense:",s),alert("Failed to fetch expense details")}},se=async t=>{if(window.confirm(`Delete safety expense ID: ${t}?`))try{await pe(t),alert("✅ Deleted successfully");const s=await N();C(s||[])}catch(s){console.error("❌ Delete failed:",s),alert("❌ Failed to delete")}},m=t=>{const{name:s,value:a}=t.target;p(d=>({...d,[s]:a}))},re=async()=>{var t,s,a,d,c;try{const l={expense_type:o.expense_type,project:o.project,safety_management:o.safety_management,amount:Number(o.amount||0),description:o.description||null,date_incurred:o.date_incurred||null};y&&k?(await me(k,l),alert("Safety expense updated")):(await ue(l),alert("Safety expense created")),_();const I=await N();C(I||[])}catch(l){console.error("❌ Error submitting safety expense:",l);const I=((s=(t=l.response)==null?void 0:t.data)==null?void 0:s.message)||((d=(a=l.response)==null?void 0:a.data)==null?void 0:d.detail)||JSON.stringify(((c=l.response)==null?void 0:c.data)||"Server error");alert(`❌ Failed to save Safety Expense.

Error: ${I}`)}},B=t=>{const s=(x||[]).find(a=>a.project===t);return(s==null?void 0:s.project_name)||t},ne=t=>{const s=new ie("l","mm","a4");s.setFontSize(16),s.text("All Safety Expenses Report",14,15);const a=["Project","Project Name","Expense Type","Amount","Safety Management","Date Incurred","Description"],d=t.map(c=>[c.project,B(c.project),c.expense_type,`₹ ${Number(c.amount||0).toLocaleString("en-IN")}`,c.safety_management||"-",Y(c.date_incurred),c.description||"-"]);ce(s,{head:[a],body:d,startY:25,styles:{fontSize:6,cellPadding:2,cellWidth:"auto",overflow:"linebreak"},headStyles:{fillColor:[114,103,239]},tableWidth:"auto"}),s.save("all_safety_expenses_report.pdf")};return e.jsxs(e.Fragment,{children:[e.jsx(M,{variant:"h5",gutterBottom:!0,sx:{mt:5},children:"Safety Expenses"}),e.jsx(i,{container:!0,spacing:2,direction:"column",sx:{mb:2},children:e.jsx(i,{item:!0,xs:12,children:e.jsxs(A,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(M,{variant:"h6",gutterBottom:!0,children:"PROJECTS"}),e.jsx(z,{sx:{my:2,mx:1},children:e.jsx("input",{type:"text",placeholder:"Search Projects",value:f,onChange:t=>J(t.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4}})}),e.jsxs(O,{children:[e.jsx(W,{children:e.jsxs(S,{children:[e.jsx(r,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project"})}),e.jsx(r,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project Name"})}),e.jsx(r,{sx:{display:"flex",justifyContent:"flex-end",color:"#660000"},children:e.jsx("strong",{children:"Action"})})]})}),e.jsx($,{children:(Q||[]).map((t,s)=>e.jsxs(S,{children:[e.jsx(r,{children:t.project}),e.jsx(r,{children:t.project_name||"-"}),e.jsx(r,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(L,{slug:j,action:"can_create",children:e.jsx(u,{onClick:()=>ee(t.project),color:"primary",children:e.jsx(je,{sx:{color:"#7267ef"}})})})})]},s))})]})]})})}),e.jsx(i,{container:!0,spacing:2,children:e.jsx(i,{item:!0,xs:12,children:e.jsxs(A,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(T,{startIcon:e.jsx(ae,{}),onClick:()=>ne(h),children:"Download PDF"}),e.jsx(M,{variant:"h6",gutterBottom:!0,children:"SAFETY EXPENSES"}),e.jsx("input",{type:"text",placeholder:"Search Safety Expenses",value:g,onChange:t=>U(t.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4,marginBottom:"16px"}}),e.jsx(_e,{sx:{maxHeight:450,overflow:"auto",border:"1px solid #ddd"},children:e.jsxs(O,{stickyHeader:!0,children:[e.jsx(W,{children:e.jsxs(S,{children:[e.jsx(r,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project"})}),e.jsx(r,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project Name"})}),e.jsx(r,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Expense Type"})}),e.jsx(r,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Amount"})}),e.jsx(r,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Safety Management"})}),e.jsx(r,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Date Incurred"})}),e.jsx(r,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Description"})}),e.jsx(r,{sx:{color:"#660000"},children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx($,{children:(V||[]).map(t=>e.jsxs(S,{children:[e.jsx(r,{children:t.project}),e.jsx(r,{children:B(t.project)}),e.jsx(r,{children:t.expense_type}),e.jsxs(r,{children:["₹ ",Number(t.amount||0).toLocaleString("en-IN")]}),e.jsx(r,{children:t.safety_management||"-"}),e.jsx(r,{children:Y(t.date_incurred)}),e.jsx(r,{children:t.description||"-"}),e.jsxs(r,{children:[e.jsx(R,{slug:j,action:"can_update",children:e.jsx(u,{color:"warning",onClick:()=>te(t),children:e.jsx(Se,{sx:{color:"orange"}})})}),e.jsx(L,{slug:j,action:"can_delete",children:e.jsx(u,{color:"error",onClick:()=>se(t.id),children:e.jsx(be,{sx:{color:"red"}})})})]})]},t.id))})]})})]})})}),e.jsxs(he,{open:q,onClose:_,fullWidth:!0,maxWidth:"lg",PaperProps:{style:F?{width:"100%",height:"100vh",margin:0}:{width:"70%",height:"90vh"}},children:[e.jsx(fe,{children:y?"Edit Safety Expense":"Create Safety Expense"}),e.jsxs(ge,{sx:{position:"relative",overflowY:"auto"},children:[e.jsx(u,{"aria-label":"toggle-size",onClick:X,sx:{position:"absolute",right:40,top:8,color:t=>t.palette.grey[600]},children:F?e.jsx(Ce,{}):e.jsx(Ee,{})}),e.jsx(u,{"aria-label":"close",onClick:_,sx:{position:"absolute",right:8,top:8,color:t=>t.palette.grey[500]},children:e.jsx(oe,{})}),e.jsx(z,{component:"form",sx:{mt:2},children:e.jsx(i,{container:!0,spacing:3,direction:"column",children:e.jsxs(i,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Expense Information"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"80%"}}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsxs(i,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"project",children:"Project"}),e.jsxs("select",{id:"project",name:"project",className:"input",value:o.project,onChange:t=>{p({...o,project:t.target.value,safety_management:""}),P(t.target.value)},children:[e.jsx("option",{value:"",children:"Select Project"}),(x||[]).map(t=>e.jsxs("option",{value:t.project,children:[t.project," ",t.project_name?`— ${t.project_name}`:""]},t.project))]})]}),e.jsxs(i,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"safety_management",children:"Safety Management"}),e.jsxs("select",{id:"safety_management",name:"safety_management",className:"input",value:o.safety_management,onChange:m,disabled:!o.project,children:[e.jsx("option",{value:"",children:"Select Safety Report"}),(Z||[]).map(t=>e.jsx("option",{value:t.safety_report_id,children:t.safety_report_id},t.safety_report_id))]})]}),e.jsxs(i,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"expense_type",children:"Expense Type"}),e.jsx("input",{id:"expense_type",name:"expense_type",className:"input",value:o.expense_type,onChange:m})]}),e.jsxs(i,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"amount",children:"Amount"}),e.jsx("input",{id:"amount",name:"amount",type:"number",className:"input",value:o.amount,onChange:m})]}),e.jsxs(i,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"date_incurred",children:"Date Incurred"}),e.jsx("input",{id:"date_incurred",name:"date_incurred",type:"date",className:"input",value:o.date_incurred,onChange:m})]}),e.jsxs(i,{item:!0,xs:12,children:[e.jsx("label",{htmlFor:"description",children:"Description"}),e.jsx("textarea",{id:"description",name:"description",className:"input",rows:3,value:o.description,onChange:m})]})]})]})})})]}),e.jsxs(ye,{children:[e.jsx(T,{onClick:_,sx:{outline:"2px solid #800000",color:"#800000","&:hover":{outline:"2px solid #b30000",color:"#b30000"}},children:"Cancel"}),e.jsx(R,{slug:j,action:y?"can_update":"can_create",children:e.jsx(T,{variant:"outlined",onClick:re,sx:{borderColor:"#7267ef",color:"#7267ef","&:hover":{borderColor:"#9e8df2",color:"#9e8df2"}},children:y?"Update Expense":"Submit Expense"})})]})]})]})};export{Re as default};
