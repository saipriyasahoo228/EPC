import{r as n,j as e,T as v,J as F,E as M,S as k,I as h,K as B}from"./main-Skim5IJC.js";import{C as ee}from"./Close-BKZ7QrSY.js";import{D as te}from"./Download-C4sxsXoP.js";import{E as re,a as se}from"./jspdf.plugin.autotable-Aj3tGQhx.js";import{f as oe,C as P,D as ne,E as ie,F as ae,G as ce}from"./construction-CMO2W9OH.js";import{f as A}from"./date-DdrLtg20.js";import{G as i}from"./Grid-fY_ATwTx.js";import{T as z,a as L,b as C,c as s,d as R}from"./TableRow-B6k_bSOs.js";import{A as le}from"./AddCircle-CJp4DZj3.js";import{B as I,D as de,a as xe,b as pe,c as he}from"./DialogTitle-CvDFHAwp.js";import{T as ue}from"./TableContainer-gCCy6yK7.js";import{E as je}from"./Edit-6vcT2Cu4.js";import{D as me}from"./Delete-Be1vvbhC.js";import{M as fe,a as ge}from"./minimize-2-RCuvNn0X.js";const Fe=()=>{const u="construction",[x,Y]=n.useState([]),[j,E]=n.useState([]),[m,G]=n.useState(""),[f,H]=n.useState(""),[W,_]=n.useState(!1),[O,$]=n.useState(!1),[g,S]=n.useState(!1),[T,D]=n.useState(null),[a,y]=n.useState({expense_type:"",project:"",amount:"",description:"",date_incurred:""}),J=()=>$(t=>!t),b=()=>{_(!1),S(!1),D(null),y({expense_type:"",project:"",amount:"",description:"",date_incurred:""})};n.useEffect(()=>{(async()=>{try{const[t,r]=await Promise.all([oe(),P()]);Y(t||[]),E(r||[])}catch(t){console.error("❌ Error loading other expense deps:",t)}})()},[]);const U=n.useMemo(()=>{if(!m)return x;const t=m.toLowerCase();return(x||[]).filter(r=>[r.project,r.project_name,r.project_status,r.location].filter(Boolean).some(o=>o.toString().toLowerCase().includes(t)))},[x,m]),q=n.useMemo(()=>{if(!f)return j;const t=f.toLowerCase();return(j||[]).filter(r=>[r.expense_type,r.project,r.amount,r.description,r.date_incurred].filter(Boolean).some(o=>o.toString().toLowerCase().includes(t)))},[j,f]),K=t=>{S(!1),D(null),y({expense_type:"",project:t||"",amount:"",description:"",date_incurred:""}),_(!0)},X=async t=>{try{const r=await ne(t.id);S(!0),D(t.id),y({expense_type:r.expense_type||"",project:r.project||"",amount:String(r.amount||""),description:r.description||"",date_incurred:(r.date_incurred||"").slice(0,10)}),_(!0)}catch(r){console.error("❌ Failed to fetch expense:",r),alert("Failed to fetch expense details")}},Q=async t=>{if(window.confirm(`Delete other expense ID: ${t}?`))try{await ie(t),alert("✅ Deleted successfully");const r=await P();E(r||[])}catch(r){console.error("❌ Delete failed:",r),alert("❌ Failed to delete")}},p=t=>{const{name:r,value:o}=t.target;y(d=>({...d,[r]:o}))},V=async()=>{var t,r,o,d,c;try{const l={expense_type:a.expense_type,project:a.project,amount:Number(a.amount||0),description:a.description||null,date_incurred:a.date_incurred||null};g&&T?(await ae(T,l),alert("Other expense updated")):(await ce(l),alert("Other expense created")),b();const w=await P();E(w||[])}catch(l){console.error("❌ Error submitting other expense:",l);const w=((r=(t=l.response)==null?void 0:t.data)==null?void 0:r.message)||((d=(o=l.response)==null?void 0:o.data)==null?void 0:d.detail)||JSON.stringify(((c=l.response)==null?void 0:c.data)||"Server error");alert(`❌ Failed to save Other Expense.

Error: ${w}`)}},N=t=>{const r=(x||[]).find(o=>o.project===t);return(r==null?void 0:r.project_name)||t},Z=t=>{const r=new re("l","mm","a4");r.setFontSize(16),r.text("All Other Expenses Report",14,15);const o=["Project","Project Name","Expense Type","Amount","Date Incurred","Description"],d=t.map(c=>[c.project,N(c.project),c.expense_type,`₹ ${Number(c.amount||0).toLocaleString("en-IN")}`,A(c.date_incurred),c.description||"-"]);se(r,{head:[o],body:d,startY:25,styles:{fontSize:6,cellPadding:2,cellWidth:"auto",overflow:"linebreak"},headStyles:{fillColor:[114,103,239]},tableWidth:"auto"}),r.save("all_other_expenses_report.pdf")};return e.jsxs(e.Fragment,{children:[e.jsx(v,{variant:"h5",gutterBottom:!0,sx:{mt:5},children:"Other Expenses"}),e.jsx(i,{container:!0,spacing:2,direction:"column",sx:{mb:2},children:e.jsx(i,{item:!0,xs:12,children:e.jsxs(F,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(v,{variant:"h6",gutterBottom:!0,children:"PROJECTS"}),e.jsx(M,{sx:{my:2,mx:1},children:e.jsx("input",{type:"text",placeholder:"Search Projects",value:m,onChange:t=>G(t.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4}})}),e.jsxs(z,{children:[e.jsx(L,{children:e.jsxs(C,{children:[e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project"})}),e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project Name"})}),e.jsx(s,{sx:{display:"flex",justifyContent:"flex-end",color:"#660000"},children:e.jsx("strong",{children:"Action"})})]})}),e.jsx(R,{children:(U||[]).map((t,r)=>e.jsxs(C,{children:[e.jsx(s,{children:t.project}),e.jsx(s,{children:t.project_name||"-"}),e.jsx(s,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(k,{slug:u,action:"can_create",children:e.jsx(h,{onClick:()=>K(t.project),color:"primary",children:e.jsx(le,{sx:{color:"#7267ef"}})})})})]},r))})]})]})})}),e.jsx(i,{container:!0,spacing:2,children:e.jsx(i,{item:!0,xs:12,children:e.jsxs(F,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(I,{startIcon:e.jsx(te,{}),onClick:()=>Z(j),children:"Download PDF"}),e.jsx(v,{variant:"h6",gutterBottom:!0,children:"OTHER EXPENSES"}),e.jsx("input",{type:"text",placeholder:"Search Other Expenses",value:f,onChange:t=>H(t.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4,marginBottom:"16px"}}),e.jsx(ue,{sx:{maxHeight:450,overflow:"auto",border:"1px solid #ddd"},children:e.jsxs(z,{stickyHeader:!0,children:[e.jsx(L,{children:e.jsxs(C,{children:[e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project"})}),e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project Name"})}),e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Expense Type"})}),e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Amount"})}),e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Date Incurred"})}),e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Description"})}),e.jsx(s,{sx:{color:"#660000"},children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(R,{children:(q||[]).map(t=>e.jsxs(C,{children:[e.jsx(s,{children:t.project}),e.jsx(s,{children:N(t.project)}),e.jsx(s,{children:t.expense_type}),e.jsxs(s,{children:["₹ ",Number(t.amount||0).toLocaleString("en-IN")]}),e.jsx(s,{children:A(t.date_incurred)}),e.jsx(s,{children:t.description||"-"}),e.jsxs(s,{children:[e.jsx(B,{slug:u,action:"can_update",children:e.jsx(h,{color:"warning",onClick:()=>X(t),children:e.jsx(je,{sx:{color:"orange"}})})}),e.jsx(k,{slug:u,action:"can_delete",children:e.jsx(h,{color:"error",onClick:()=>Q(t.id),children:e.jsx(me,{sx:{color:"red"}})})})]})]},t.id))})]})})]})})}),e.jsxs(de,{open:W,onClose:b,fullWidth:!0,maxWidth:"lg",PaperProps:{style:O?{width:"100%",height:"100vh",margin:0}:{width:"70%",height:"90vh"}},children:[e.jsx(xe,{children:g?"Edit Other Expense":"Create Other Expense"}),e.jsxs(pe,{sx:{position:"relative",overflowY:"auto"},children:[e.jsx(h,{"aria-label":"toggle-size",onClick:J,sx:{position:"absolute",right:40,top:8,color:t=>t.palette.grey[600]},children:O?e.jsx(fe,{}):e.jsx(ge,{})}),e.jsx(h,{"aria-label":"close",onClick:b,sx:{position:"absolute",right:8,top:8,color:t=>t.palette.grey[500]},children:e.jsx(ee,{})}),e.jsx(M,{component:"form",sx:{mt:2},children:e.jsx(i,{container:!0,spacing:3,direction:"column",children:e.jsxs(i,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Expense Information"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"80%"}}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsxs(i,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"project",children:"Project"}),e.jsxs("select",{id:"project",name:"project",className:"input",value:a.project,onChange:p,children:[e.jsx("option",{value:"",children:"Select Project"}),(x||[]).map(t=>e.jsxs("option",{value:t.project,children:[t.project," ",t.project_name?`— ${t.project_name}`:""]},t.project))]})]}),e.jsxs(i,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"expense_type",children:"Expense Type"}),e.jsx("input",{id:"expense_type",name:"expense_type",className:"input",value:a.expense_type,onChange:p})]}),e.jsxs(i,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"amount",children:"Amount"}),e.jsx("input",{id:"amount",name:"amount",type:"number",className:"input",value:a.amount,onChange:p})]}),e.jsxs(i,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"date_incurred",children:"Date Incurred"}),e.jsx("input",{id:"date_incurred",name:"date_incurred",type:"date",className:"input",value:a.date_incurred,onChange:p})]}),e.jsxs(i,{item:!0,xs:12,children:[e.jsx("label",{htmlFor:"description",children:"Description"}),e.jsx("textarea",{id:"description",name:"description",className:"input",rows:3,value:a.description,onChange:p})]})]})]})})})]}),e.jsxs(he,{children:[e.jsx(I,{onClick:b,sx:{outline:"2px solid #800000",color:"#800000","&:hover":{outline:"2px solid #b30000",color:"#b30000"}},children:"Cancel"}),e.jsx(B,{slug:u,action:g?"can_update":"can_create",children:e.jsx(I,{variant:"outlined",onClick:V,sx:{borderColor:"#7267ef",color:"#7267ef","&:hover":{borderColor:"#9e8df2",color:"#9e8df2"}},children:g?"Update Expense":"Submit Expense"})})]})]})]})};export{Fe as default};
