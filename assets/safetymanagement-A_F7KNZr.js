import{r as a,j as e,T as D,z as F}from"./main-IxGEKZMA.js";import{C as q}from"./Close-DoqWsXz3.js";import{g as K}from"./engineering-BuN6Pdrr.js";import{l as V,m as X,n as Z,o as ee}from"./construction-Ca90qLEO.js";import{G as s}from"./Grid-C72N-tAO.js";import{t as N,T as P,h as R,i as p,j as n,I as f,k as te,D as re,f as ne,g as se,e as k}from"./TableRow-CRAT5KT_.js";import{A as ie}from"./AddCircle-DWIRGPUh.js";import{T as oe}from"./TableContainer-BaU58JEj.js";import{E as ae}from"./Edit-g2hjeeYC.js";import{D as ce}from"./Delete-cHl_EB0l.js";import{D as le}from"./DialogActions-D5wP0Mt-.js";import"./Transition-C29ZPDdz.js";const be=()=>{const[v,A]=a.useState(""),[I,B]=a.useState(""),[$,m]=a.useState(!1),[b,_]=a.useState(""),[i,x]=a.useState({}),[L,de]=a.useState([]),[O,C]=a.useState(!1),[xe,M]=a.useState(null),[Y,G]=a.useState([]),[g,w]=a.useState([]),[y,H]=a.useState(null);a.useEffect(()=>{(async()=>{try{const r=await K();G(r)}catch(r){console.error("Error fetching projects:",r)}})()},[]),a.useEffect(()=>{T()},[]);const T=async()=>{try{const t=await V();w(t)}catch(t){console.error("❌ Error fetching safety records:",t)}},Q=t=>{console.log("handleOpenForm called with projectId:",t),console.log("Current safetyRecords data:",g),_(t);const r=new Date().getFullYear(),c=g.filter(o=>o.safety_report_id&&o.safety_report_id.includes(`-${r}-`)).map(o=>{const E=o.safety_report_id.split("-"),W=E[E.length-1];return parseInt(W,10)}).filter(o=>!isNaN(o));console.log("Filtered currentYearIDs:",c);const d=c.length>0?Math.max(...c):0;console.log("Max number found:",d);const j=(d+1).toString().padStart(4,"0"),l=`SAF-${r}-${j}`;x({safetymanagementID:l,projectId:t}),C(!1),M(null),m(!0)},z=t=>{x({safetymanagementID:t.safety_report_id,incidentDate:t.incident_date,incidentDescription:t.incident_description,affectedpersonnelID:t.affected_personnel_id,injurySeverity:t.injury_severity,correctiveMeasures:t.corrective_measure,safetyTraining:t.safety_training_conducted}),_(t.project),H(t.safety_report_id),m(!0)},J=async t=>{if(window.confirm(`Are you sure you want to delete Safety ID: ${t}?`)){console.log("🆔 Safety ID to delete:",t);try{await X(t),alert("✅ Record deleted successfully"),T(),w(r=>r.filter(c=>c.safetyId!==t))}catch(r){console.error("❌ Error deleting safety record:",r),alert("❌ Failed to delete record")}}},u=()=>{m(!1),x({}),C(!1),M(null)},h=t=>{const{name:r,value:c}=t.target;x(d=>({...d,[r]:c}))},U=async()=>{var t,r,c,d,S,j;try{const l={project:b,incident_date:i.incidentDate,incident_description:i.incidentDescription,affected_personnel_id:i.affectedpersonnelID,injury_severity:(t=i.injurySeverity)==null?void 0:t.toLowerCase(),corrective_measure:i.correctiveMeasures,safety_training_conducted:i.safetyTraining};let o;y?(o=await Z(y,l),alert(`✏️ Safety Management updated! Report ID: ${o.safety_report_id}`)):(o=await ee(l),alert(`✅ Safety Management created! Report ID: ${o.safety_report_id}`)),u()}catch(l){const o=((c=(r=l.response)==null?void 0:r.data)==null?void 0:c.message)||((S=(d=l.response)==null?void 0:d.data)==null?void 0:S.detail)||"Something went wrong on the server.";alert(`❌ Failed to save Safety Management record.

Error: ${o}`),console.error("❌ Error saving Safety Management record:",((j=l.response)==null?void 0:j.data)||l.message)}};return L.filter(t=>Object.values(t).some(r=>r&&r.toString().toLowerCase().includes(I.toLowerCase()))),e.jsxs(e.Fragment,{children:[e.jsx(D,{variant:"h5",gutterBottom:!0,sx:{mt:5},children:"Safety Management"}),e.jsx(s,{container:!0,spacing:2,direction:"column",sx:{mb:2},children:e.jsx(s,{item:!0,xs:12,children:e.jsxs(N,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(D,{variant:"h6",gutterBottom:!0,children:"PROJECT RECORDS"}),e.jsx(F,{sx:{my:2,mx:1},children:e.jsx("input",{type:"text",placeholder:"Search Project ID",value:v,onChange:t=>A(t.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4}})}),e.jsxs(P,{children:[e.jsx(R,{children:e.jsxs(p,{children:[e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project ID"})}),e.jsx(n,{sx:{display:"flex",justifyContent:"flex-end",color:"#660000"},children:e.jsx("strong",{children:"Action"})})]})}),Y.filter(t=>String(t.id).toLowerCase().includes(v.toLowerCase())).map((t,r)=>e.jsxs(p,{children:[e.jsx(n,{children:t.project_id}),e.jsx(n,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(f,{onClick:()=>Q(t.project_id),color:"primary",children:e.jsx(ie,{sx:{color:"#7267ef"}})})})]},r))]})]})})}),e.jsx(s,{container:!0,spacing:2,children:e.jsx(s,{item:!0,xs:12,children:e.jsxs(N,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(D,{variant:"h6",gutterBottom:!0,children:"SAFETY MANAGEMENT DETAILS"}),e.jsx("input",{type:"text",placeholder:"Search Safety Management",value:I,onChange:t=>B(t.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4,marginBottom:"16px"}}),e.jsx(oe,{sx:{maxHeight:400,overflow:"auto",border:"1px solid #ddd"},children:e.jsxs(P,{stickyHeader:!0,children:[e.jsx(R,{children:e.jsxs(p,{children:[e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project ID"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Safety Report ID"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Incident Date"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Incident Description"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Affected Personnel ID"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Injury Severity"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Corrective Measures"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Safety Training Conducted"})}),e.jsx(n,{sx:{color:"#660000"},children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(te,{children:g.map((t,r)=>e.jsxs(p,{children:[e.jsx(n,{children:t.project}),e.jsx(n,{children:t.safety_report_id}),e.jsx(n,{children:t.incident_date}),e.jsx(n,{children:t.incident_description}),e.jsx(n,{children:t.affected_personnel_id}),e.jsx(n,{children:t.injury_severity}),e.jsx(n,{children:t.corrective_measure}),e.jsx(n,{children:t.safety_training_conducted?"Yes":"No"}),e.jsxs(n,{children:[e.jsx(f,{onClick:()=>z(t),color:"warning",children:e.jsx(ae,{sx:{color:"orange"}})}),e.jsx(f,{onClick:()=>J(t.safety_report_id),color:"error",children:e.jsx(ce,{sx:{color:"red"}})})]})]},r))})]})})]})})}),e.jsxs(re,{open:$,onClose:u,fullWidth:!0,children:[e.jsx(ne,{children:O?"Edit Safety Management Details":"Enter Safety Management Details"}),e.jsxs(se,{sx:{position:"relative"},children:[e.jsx(f,{"aria-label":"close",onClick:u,sx:{position:"absolute",right:8,top:8,color:t=>t.palette.grey[500]},children:e.jsx(q,{})}),e.jsx(F,{component:"form",sx:{mt:2},children:e.jsxs(s,{container:!0,spacing:3,direction:"column",children:[e.jsxs(s,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Project Information"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"80%"}}),e.jsxs(s,{container:!0,spacing:2,children:[e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"projectId",children:"Project ID"}),e.jsx("input",{id:"projectId",className:"input",value:b,disabled:!0})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"safetymanagementID",children:"Safety Report ID"}),e.jsx("input",{id:"safetymanagementID",className:"input",value:i.safetymanagementID||"",disabled:!0})]})]})]}),e.jsxs(s,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Incident Information"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"80%"}}),e.jsxs(s,{container:!0,spacing:2,children:[e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"incidentDate",children:"Incident Date"}),e.jsx("input",{type:"date",id:"incidentDate",name:"incidentDate",className:"input",value:i.incidentDate||"",onChange:h})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"incidentDescription",children:"Incident Description"}),e.jsx("textarea",{rows:3,id:"incidentDescription",name:"incidentDescription",className:"input",value:i.incidentDescription||"",onChange:h})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"affectedpersonnelID",children:"Affected Personnel ID"}),e.jsx("input",{id:"affectedpersonnelID",name:"affectedpersonnelID",className:"input",value:i.affectedpersonnelID||"",onChange:h})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"injurySeverity",children:"Injury Severity"}),e.jsxs("select",{id:"injurySeverity",name:"injurySeverity",className:"input",value:i.injurySeverity||"",onChange:h,children:[e.jsx("option",{value:"",children:"Select Severity"}),e.jsx("option",{value:"Minor",children:"Minor"}),e.jsx("option",{value:"moerate",children:"Moderate"}),e.jsx("option",{value:"Severe",children:"Severe"}),e.jsx("option",{value:"Fatal",children:"Fatal"})]})]})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"correctiveMeasures",children:"Corrective Measures"}),e.jsx("input",{id:"correctiveMeasures",name:"correctiveMeasures",className:"input",value:i.correctiveMeasures||"",onChange:h})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"safetyTraining",children:"Safety Training Conducted"}),e.jsx("input",{type:"checkbox",id:"safetyTraining",name:"safetyTraining",checked:i.safetyTraining||!1,onChange:t=>x({...i,safetyTraining:t.target.checked})})]})]})]})})]}),e.jsxs(le,{children:[e.jsx(k,{onClick:u,sx:{outline:"2px solid #800000",color:"#800000","&:hover":{outline:"2px solid #b30000",color:"#b30000"}},children:"Cancel"}),e.jsx(k,{variant:"outlined",onClick:U,sx:{borderColor:"#7267ef",color:"#7267ef","&:hover":{borderColor:"#9e8df2",color:"#9e8df2"}},children:y?"Update":"Submit"})]})]})]})};export{be as default};
