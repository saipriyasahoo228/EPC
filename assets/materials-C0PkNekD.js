import{r as n,j as e,T as y,J as X,E as v,S as U,I as d,Q as pe,K as Q}from"./main-Skim5IJC.js";import{C as he}from"./Close-BKZ7QrSY.js";import{g as je}from"./engineering-BJ3wTiKO.js";import{a as ye,b as fe,e as _e,f as ge}from"./procurement-BWIn9uW6.js";import{g as Ce}from"./inventory-BCILrqmV.js";import{E as Pe,a as ve}from"./jspdf.plugin.autotable-Aj3tGQhx.js";import{D as be}from"./Download-C4sxsXoP.js";import{G as o}from"./Grid-fY_ATwTx.js";import{T as Y,a as H,b as f,c as s,d as W}from"./TableRow-B6k_bSOs.js";import{A as Se}from"./AddCircle-CJp4DZj3.js";import{A as G,a as J}from"./ArrowForwardIos-D05tyAMF.js";import{B as b,D as De,a as qe,b as Ie,c as we}from"./DialogTitle-CvDFHAwp.js";import{T as Ne}from"./TableContainer-gCCy6yK7.js";import{E as Fe}from"./Edit-6vcT2Cu4.js";import{D as Me}from"./Delete-Be1vvbhC.js";import{M as Te,a as ke}from"./minimize-2-RCuvNn0X.js";const et=()=>{const _="procurement",[S,K]=n.useState(""),[V,Z]=n.useState([]),[D,k]=n.useState([]),[B,ee]=n.useState(""),[te,g]=n.useState(!1),[Be,ae]=n.useState(""),[Ee,Ae]=n.useState(!1),[q,I]=n.useState("create"),w=1,[p,E]=n.useState(1),[h,A]=n.useState(1),N=5,[F,re]=n.useState(!1),[r,x]=n.useState({projectId:"",procurementId:"",materialName:"",materialCode:"",quantity:"",unitPrice:"",totalCost:"",requestedBy:"",requestDate:"",approvalStatus:"Pending",poId:"",expectedDeliveryDate:"",paymentStatus:""}),[R,se]=n.useState([]),[ie,C]=n.useState(""),oe=()=>{re(!F)},le=t=>{const a=new Pe("p","mm","a4");a.setFontSize(14),a.text("Your Company Name",14,20),a.setFontSize(10),a.text("Address Line 1, City, Country",14,26),a.text("Phone: +91-XXXXXXXXXX",14,32),a.setLineWidth(.5),a.line(140,10,140,40),a.setFontSize(12),a.text(`Date: ${t.procurements[0].request_date}`,145,26),a.text(`Project: ${t.project_id}`,145,32);const i=["Material Name","Material Code","Qty","Unit Price","Total Cost"],c=t.procurements.map(u=>[u.material_name,u.material_code,u.quantity_requested,u.unit_price,u.total_cost]);ve(a,{head:[i],body:c,startY:50,styles:{fontSize:10},headStyles:{fillColor:[114,103,239]},theme:"plain"});const l=a.lastAutoTable.finalY+10;a.setFontSize(12),a.text(`Total Cost: Rs ${t.total_cost.toFixed(2)} `,14,l),a.setFontSize(10),a.text("Prepared By: ________________",14,l+15),a.text("Reviewed By: ________________",80,l+15),a.text("Authorized Signatory: ________________",140,l+15),a.save(`Purchase_Order_${t.project_id}.pdf`)},L=V.filter(t=>t.project_id.toLowerCase().includes(S.toLowerCase())),$=Math.ceil(L.length/w),ne=L.slice((p-1)*w,p*w);n.useEffect(()=>{(async()=>{try{const a=await je();Z(a)}catch(a){console.error("Failed to load accepted projects:",a)}})()},[]);const P=async()=>{try{const t=await ye();console.log(t),k(t)}catch(t){console.error("❌ Error loading procurements:",t)}};n.useEffect(()=>{P()},[]),n.useEffect(()=>{(async()=>{try{const a=await Ce();se(a)}catch(a){console.error("Failed to load inventory items:",a)}})()},[]);const m=t=>{const{name:a,value:i}=t.target;x(c=>{const l={...c,[a]:i};if(a==="quantity"||a==="unitPrice"){const u=parseFloat(l.quantity)||0,T=parseFloat(l.unitPrice)||0,j=(u*T).toFixed(2);l.totalCost=j}return l})},ce=t=>{const a=t.target.value;C(a);const i=a.includes(" - ")?a.split(" - ")[0].trim():a.trim(),c=R.find(l=>l.item_id===i||`${l.item_id} - ${l.item_name}`===a.trim());x(c?l=>({...l,materialCode:c.item_id,materialName:c.item_name}):l=>({...l,materialCode:"",materialName:""}))},de=t=>{const a=new Date().getFullYear(),c=(D.length+1).toString().padStart(3,"0"),l=`${a}-PRC-${c}`;x({projectId:t,procurementId:l,materialName:"",materialCode:"",quantity:"",unitPrice:"",totalCost:"",requestedBy:"",requestDate:"",approvalStatus:"Pending",paymentStatus:"Pending",expectedDeliveryDate:""}),C(""),I("create"),g(!0)},M=()=>g(!1),ue=async()=>{var a;if(!r.materialCode||!r.materialName){alert("Please select a material from the list.");return}if(!r.quantity||isNaN(Number(r.quantity))||Number(r.quantity)<=0){alert("Please enter the requested quantity (must be greater than 0).");return}if(!r.requestedBy||!r.requestedBy.trim()){alert("Please specify who requested the material.");return}if(!r.requestDate){alert("Please select the request date.");return}const t=new FormData;t.append("project",r.projectId),t.append("material_name",r.materialName),t.append("material_code",r.materialCode),t.append("quantity_requested",r.quantity),t.append("unit_price",r.unitPrice),t.append("requested_by",r.requestedBy),t.append("request_date",r.requestDate),t.append("approval_status",r.approvalStatus||"Pending"),t.append("payment_status",r.paymentStatus||"Pending"),r.expectedDeliveryDate&&t.append("expected_delivery_date",r.expectedDeliveryDate);try{q==="update"?(await _e(r.procurementId,t),alert("✅ Material Procurement updated successfully!")):(await ge(t),alert("✅ Material Procurement submitted successfully!")),x({projectId:"",procurementId:"",materialName:"",materialCode:"",quantity:"",unitPrice:"",totalCost:"",requestedBy:"",requestDate:"",approvalStatus:"",paymentStatus:"",expectedDeliveryDate:""}),ae(null),g(!1),I("create"),C(""),typeof P=="function"&&await P()}catch(i){const c=(a=i.response)==null?void 0:a.data;console.error("❌ Submission failed:",c||i.message);let l="Submission failed. Please check form values.";c&&typeof c=="object"&&(l=Object.entries(c).map(([T,j])=>`${T}: ${Array.isArray(j)?j.join(", "):j}`).join(`
`)),alert(`❌ ${l}`)}},me=t=>{x({projectId:t.project,procurementId:t.procurement_id,materialName:t.material_name,materialCode:t.material_code,quantity:t.quantity_requested,unitPrice:t.unit_price,totalCost:t.total_cost,requestedBy:t.requested_by,requestDate:t.request_date,approvalStatus:t.approval_status,paymentStatus:t.payment_status,expectedDeliveryDate:t.expected_delivery_date}),C(t.material_code&&t.material_name?`${t.material_code} - ${t.material_name}`:t.material_code||""),I("update"),g(!0)},xe=async t=>{if(window.confirm(`Delete ${t}?`))try{await fe(t),alert(`Deleted ${t} successfully`),P(),k(i=>i.filter(c=>c.procurementId!==t))}catch{alert("Failed to delete. Check console for details.")}},z=D.filter(t=>Object.values(t).some(a=>a&&a.toString().toLowerCase().includes(B.toLowerCase()))),O=Math.ceil(z.length/N);return z.slice((h-1)*N,h*N),e.jsxs(e.Fragment,{children:[e.jsx(y,{variant:"h5",gutterBottom:!0,sx:{mt:5},children:"Material Procurement"}),e.jsx(o,{container:!0,spacing:2,direction:"column",sx:{mb:2},children:e.jsx(o,{item:!0,xs:12,children:e.jsxs(X,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(y,{variant:"h6",gutterBottom:!0,children:"PROJECT RECORDS"}),e.jsx(v,{sx:{my:2,mx:1},children:e.jsx("input",{type:"text",placeholder:"Search Project ID",value:S,onChange:t=>K(t.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4}})}),e.jsxs(Y,{children:[e.jsx(H,{children:e.jsxs(f,{children:[e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project ID"})}),e.jsx(s,{sx:{display:"flex",justifyContent:"flex-end",color:"#660000"},children:e.jsx("strong",{children:"Action"})})]})}),e.jsx(W,{children:ne.filter(t=>{var a;return(a=t.project_id)==null?void 0:a.toLowerCase().includes(S.toLowerCase())}).map((t,a)=>e.jsxs(f,{children:[e.jsx(s,{children:t.project_id}),e.jsx(s,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(U,{slug:_,action:"can_create",children:e.jsx(d,{onClick:()=>de(t.project_id),color:"primary",children:e.jsx(Se,{sx:{color:"#7267ef"}})})})})]},a))})]}),e.jsxs(v,{display:"flex",justifyContent:"flex-end",alignItems:"center",mt:2,pr:2,children:[e.jsx(d,{disabled:p===1,onClick:()=>E(t=>t-1),children:e.jsx(G,{})}),e.jsxs(y,{variant:"body2",sx:{mx:2},children:["Page ",p," of ",$||1]}),e.jsx(d,{disabled:p>=$,onClick:()=>E(t=>t+1),children:e.jsx(J,{})})]})]})})}),e.jsx(o,{container:!0,spacing:2,children:e.jsx(o,{item:!0,xs:12,children:e.jsxs(X,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(b,{startIcon:e.jsx(be,{})}),e.jsx(y,{variant:"h6",gutterBottom:!0,children:"SUBMITTED MATERIALS PROCUREMENT RECORDS"}),e.jsx("input",{type:"text",placeholder:"Search Materials Procurements Here....",value:B,onChange:t=>ee(t.target.value),className:"input"}),e.jsx(Ne,{sx:{maxHeight:500,overflow:"auto",border:"1px solid #ddd"},children:e.jsxs(Y,{stickyHeader:!0,size:"small",children:[e.jsx(H,{children:e.jsxs(f,{children:[e.jsx(s,{sx:{color:"#7267ef"},children:"Procurement ID"}),e.jsx(s,{sx:{color:"#7267ef"},children:"Purchase Order ID"}),e.jsx(s,{sx:{color:"#7267ef"},children:"Material Name"}),e.jsx(s,{sx:{color:"#7267ef"},children:"Material Code"}),e.jsx(s,{sx:{color:"#7267ef"},children:"Quantity"}),e.jsx(s,{sx:{color:"#7267ef"},children:"Unit Price"}),e.jsx(s,{sx:{color:"#7267ef"},children:"Total Cost"}),e.jsx(s,{sx:{color:"#7267ef"},children:"Requested By"}),e.jsx(s,{sx:{color:"#7267ef"},children:"Request Date"}),e.jsx(s,{sx:{color:"#7267ef"},children:"Approval Status"}),e.jsx(s,{sx:{color:"#7267ef"},children:"Payment Status"}),e.jsx(s,{sx:{color:"#7267ef"},children:"Expected Delivery"}),e.jsx(s,{sx:{color:"#660000"},children:"Actions"})]})}),e.jsx(W,{children:D.map(t=>{var a;return e.jsxs(pe.Fragment,{children:[e.jsxs(f,{sx:{backgroundColor:"#f0f0f0"},children:[e.jsxs(s,{colSpan:10,sx:{fontWeight:"bold"},children:["Project: ",t.project_id," | Total Cost: ₹",t.total_cost," | Status: ",t.project_status]}),e.jsx(s,{colSpan:3,align:"right",children:e.jsx(b,{variant:"contained",color:"primary",size:"small",onClick:()=>le(t),children:"Download Project PDF"})})]}),(a=t.procurements)==null?void 0:a.map(i=>e.jsxs(f,{children:[e.jsx(s,{children:i.procurement_id}),e.jsx(s,{children:i.purchase_order||"-"}),e.jsx(s,{children:i.material_name}),e.jsx(s,{children:i.material_code}),e.jsx(s,{children:i.quantity_requested}),e.jsx(s,{children:i.unit_price}),e.jsx(s,{children:i.total_cost}),e.jsx(s,{children:i.requested_by}),e.jsx(s,{children:i.request_date}),e.jsx(s,{children:i.approval_status}),e.jsx(s,{children:i.payment_status}),e.jsx(s,{children:i.expected_delivery_date||"N/A"}),e.jsxs(s,{children:[e.jsx(Q,{slug:_,action:"can_update",children:e.jsx(d,{color:"warning",onClick:()=>me(i),children:e.jsx(Fe,{sx:{color:"orange"}})})}),e.jsx(U,{slug:_,action:"can_delete",children:e.jsx(d,{color:"error",onClick:()=>xe(i.procurement_id),children:e.jsx(Me,{sx:{color:"red"}})})})]})]},i.procurement_id))]},t.project_id)})})]})}),e.jsxs(v,{display:"flex",justifyContent:"flex-end",alignItems:"center",mt:2,pr:2,children:[e.jsx(d,{disabled:h===1,onClick:()=>A(t=>t-1),children:e.jsx(G,{})}),e.jsxs(y,{variant:"body2",sx:{mx:2},children:["Page ",h," of ",O||1]}),e.jsx(d,{disabled:h>=O,onClick:()=>A(t=>t+1),children:e.jsx(J,{})})]})]})})}),e.jsxs(De,{open:te,onClose:M,fullWidth:!0,maxWidth:"xl",PaperProps:{style:F?{width:"100%",height:"100vh",margin:0}:{width:"70%",height:"97vh"}},children:[e.jsx(qe,{children:"Enter Procurement Details"}),e.jsxs(Ie,{sx:{position:"relative",overflowY:"auto"},children:[e.jsx(d,{"aria-label":"toggle-size",onClick:oe,sx:{position:"absolute",right:40,top:8,color:t=>t.palette.grey[600]},children:F?e.jsx(Te,{}):e.jsx(ke,{})}),e.jsx(d,{"aria-label":"close",onClick:M,sx:{position:"absolute",right:8,top:8,color:t=>t.palette.grey[500]},children:e.jsx(he,{})}),e.jsx(v,{component:"form",sx:{mt:2},children:e.jsxs(o,{container:!0,spacing:3,direction:"column",children:[e.jsxs(o,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Project & Procurement Info"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"100%"}}),e.jsxs(o,{container:!0,spacing:2,children:[e.jsxs(o,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"projectId",children:"Project ID"}),e.jsx("input",{id:"projectId",name:"projectId",className:"input",value:r.projectId||"",disabled:!0})]}),e.jsxs(o,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"procurementId",children:"Procurement ID"}),e.jsx("input",{id:"procurementId",name:"procurementId",className:"input",value:r.procurementId||"",disabled:!0})]})]})]}),e.jsxs(o,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Material Information"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"100%"}}),e.jsxs(o,{container:!0,spacing:2,children:[e.jsxs(o,{item:!0,xs:12,children:[e.jsx("label",{htmlFor:"materialLookup",children:"Search Material (Code - Name)"}),e.jsx("input",{list:"materialOptions",id:"materialLookup",name:"materialLookup",className:"input",value:ie,onChange:ce,placeholder:"Type to search e.g., ITM-2025-0001",autoComplete:"off"}),e.jsx("datalist",{id:"materialOptions",children:R.map(t=>e.jsx("option",{value:`${t.item_id} - ${t.item_name}`},t.item_id))})]}),e.jsxs(o,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"materialName",children:"Material Name"}),e.jsx("input",{id:"materialName",name:"materialName",className:"input",value:r.materialName||"",readOnly:!0,disabled:!0})]}),e.jsxs(o,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"materialCode",children:"Material Code"}),e.jsx("input",{id:"materialCode",name:"materialCode",className:"input",value:r.materialCode||"",readOnly:!0,disabled:!0})]}),e.jsxs(o,{item:!0,xs:6,children:[e.jsxs("label",{htmlFor:"quantity",children:["Quantity ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("input",{type:"number",id:"quantity",name:"quantity",className:"input",value:r.quantity||"",onChange:m,min:0})]}),e.jsxs(o,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"unitPrice",children:"Unit Price"}),e.jsx("input",{id:"unitPrice",name:"unitPrice",className:"input",value:r.unitPrice||"",onChange:m})]})]})]}),e.jsxs(o,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Cost & Info"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"100%"}}),e.jsxs(o,{container:!0,spacing:2,children:[e.jsxs(o,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"totalCost",children:"Total Cost"}),e.jsx("input",{id:"totalCost",name:"totalCost",className:"input",value:r.totalCost||"",disabled:!0})]}),e.jsxs(o,{item:!0,xs:6,children:[e.jsxs("label",{htmlFor:"requestedBy",children:["Requested By ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("input",{id:"requestedBy",name:"requestedBy",className:"input",value:r.requestedBy||"",onChange:m})]}),e.jsxs(o,{item:!0,xs:6,children:[e.jsxs("label",{htmlFor:"requestDate",children:["Request Date ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("input",{type:"date",id:"requestDate",name:"requestDate",className:"input",value:r.requestDate||"",onChange:m})]})]})]}),e.jsxs(o,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Approval & Payment"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"100%"}}),e.jsxs(o,{container:!0,spacing:2,children:[e.jsxs(o,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"approvalStatus",children:"Approval Status"}),e.jsxs("select",{id:"approvalStatus",name:"approvalStatus",className:"input",value:r.approvalStatus||"",onChange:m,children:[e.jsx("option",{value:"",children:"Select Approval Status"}),e.jsx("option",{value:"Pending",children:"Pending"}),e.jsx("option",{value:"Approved",children:"Approved"}),e.jsx("option",{value:"Rejected",children:"Rejected"})]})]}),e.jsxs(o,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"expectedDeliveryDate",children:"Expected Delivery Date"}),e.jsx("input",{type:"date",id:"expectedDeliveryDate",name:"expectedDeliveryDate",className:"input",value:r.expectedDeliveryDate||"",onChange:m})]}),e.jsxs(o,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"paymentStatus",children:"Payment Status"}),e.jsxs("select",{id:"paymentStatus",name:"paymentStatus",className:"input",value:r.paymentStatus||"",onChange:m,children:[e.jsx("option",{value:"",children:"Select Payment Status"}),e.jsx("option",{value:"Pending",children:"Pending"}),e.jsx("option",{value:"Completed",children:"Completed"}),e.jsx("option",{value:"Partially Paid",children:"Partially Paid"})]})]})]})]})]})})]}),e.jsxs(we,{children:[e.jsx(b,{onClick:M,sx:{outline:"2px solid #800000",color:"#800000","&:hover":{outline:"2px solid #b30000",color:"#b30000"}},children:"Cancel"}),e.jsx(Q,{slug:_,action:q==="update"?"can_update":"can_create",children:e.jsx(b,{variant:"outlined",onClick:ue,sx:{borderColor:"#7267ef",color:"#7267ef","&:hover":{borderColor:"#9e8df2",color:"#9e8df2"}},children:q==="update"?"Update Procurement":"Submit Procurement"})})]})]})]})};export{et as default};
