import{r as l,j as e,E as d,T as S,J as E,K as B,I as m,S as W}from"./main-Skim5IJC.js";import{C as xe}from"./Close-BKZ7QrSY.js";import{H as He,i as Ye,I as Ge,J as Je,K as qe,L as Ke,M as Xe,N as Qe,O as Ze,P as De}from"./construction-CMO2W9OH.js";import{g as er}from"./procurement-BWIn9uW6.js";import{E as rr,a as he}from"./jspdf.plugin.autotable-Aj3tGQhx.js";import{B as g,D as q,a as K,b as X,c as Q}from"./DialogTitle-CvDFHAwp.js";import{G as i}from"./Grid-fY_ATwTx.js";import{T as z,a as N,b as j,c as s,d as M}from"./TableRow-B6k_bSOs.js";import{E as ue}from"./Edit-6vcT2Cu4.js";import{D as ge}from"./Delete-Be1vvbhC.js";import{T as Z}from"./TableContainer-gCCy6yK7.js";import{M as je,a as pe}from"./minimize-2-RCuvNn0X.js";import{C as or}from"./Checkbox-pnRANLqZ.js";import"./useFormControl-C6hS7-Rn.js";import"./useControlled-CHkDrNg3.js";const yr=()=>{const p="construction",me=[{value:"skilled",label:"Skilled"},{value:"semi_skilled",label:"Semi-Skilled"},{value:"unskilled",label:"Unskilled"}],[P,ye]=l.useState([]),[D,fe]=l.useState([]),[H,Ce]=l.useState([]),[be,Y]=l.useState(!1),[F,ee]=l.useState(!1),[k,_e]=l.useState([]),[f,ve]=l.useState(""),[G,we]=l.useState(""),[J,Se]=l.useState(""),[ke,C]=l.useState(!1),[Re,b]=l.useState(!1),[T,re]=l.useState(!1),[A,oe]=l.useState(!1),[I,se]=l.useState(null),[$,te]=l.useState(null),[O,Le]=l.useState(!1),[U,V]=l.useState({category:"",subcategory:""}),[_,R]=l.useState({category_id:"",vendor:"",is_company:!1}),ne=()=>Le(r=>!r),u=r=>typeof r=="string"?r.replace(/\w\S*/g,o=>o.charAt(0).toUpperCase()+o.slice(1).toLowerCase()):r,le=async()=>{ee(!0);try{const r={};f&&(r.vendor_id=f);const o=await Qe(r);_e(Array.isArray(o)?o:[])}catch(r){console.error("❌ Failed to fetch vendor report:",r),alert("Failed to load vendor report")}finally{ee(!1)}},Ee=async()=>{Y(!0),le()},Fe=()=>{var ie;if(!k.length)return;const r=new rr({unit:"pt",format:"a4"}),o=40,t=40,a=18,v=f?((ie=H.find(h=>String(h.vendor_id)===String(f)))==null?void 0:ie.vendor_name)||f:"All Vendors";let n=t;r.setFont("helvetica","bold"),r.setFontSize(16),r.text("Vendor Labour Usage Report",o,n),n+=a,r.setFont("helvetica","normal"),r.setFontSize(10),r.text(`Generated: ${new Date().toLocaleString()}`,o,n),n+=a,r.text(`Vendor Filter: ${v}`,o,n),n+=a,k.forEach((h,Ne)=>{if(Ne>0&&(r.addPage(),n=t),r.setFont("helvetica","bold"),r.setFontSize(13),r.text(`${h.vendor_name||"Unknown Vendor"} ${h.vendor_id?`(${h.vendor_id})`:""}`,o,n),n+=a-2,r.setFont("helvetica","normal"),r.setFontSize(10),r.text(`Total Workers: ${h.total_workers??"-"}`,o,n),r.text(`Total Hours: ${h.total_work_hours??"-"}`,o+180,n),r.text(`Total Effort: ${h.total_effort??"-"}`,o+320,n),n+=a,h.categories){const c=[];Object.entries(h.categories).forEach(([ce,y])=>{const de=y!=null&&y.subcategories?Object.entries(y.subcategories):[];de.length?de.forEach(([Pe,w])=>{c.push([u(ce),u(Pe),(w==null?void 0:w.total_workers)??"-",((w==null?void 0:w.details)||[]).length])}):c.push([u(ce),"—",(y==null?void 0:y.total_workers)??"-","—"])}),he(r,{startY:n,head:[["Category","Subcategory","Total Workers","Entries"]],body:c,styles:{fontSize:9},headStyles:{fillColor:[246,247,251],textColor:20},margin:{left:o,right:o}}),n=r.lastAutoTable.finalY+12}const Me=(h.details||[]).map(c=>[c.site_execution||"-",c.project||"-",u(c.category||"-"),u(c.subcategory||"-"),c.number_of_workers??"-",c.work_hours??"-",c.total_effort??"-",c.date?new Date(c.date).toLocaleString():"-"]);he(r,{startY:n,head:[["Site","Project","Category","Subcategory","# Workers","Hours","Total Effort","Date"]],body:Me,styles:{fontSize:9},headStyles:{fillColor:[246,247,251],textColor:20},margin:{left:o,right:o}}),n=r.lastAutoTable.finalY+12});const x=new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");r.save(`Vendor-Labour-Usage-Report-${x}.pdf`)},L=async()=>{try{const[r,o,t]=await Promise.all([He(),Ye(),er()]);ye(Array.isArray(r)?r:r?[r]:[]),fe(Array.isArray(o)?o:[]),Ce(Array.isArray(t)?t:[]),console.log("Check: LABOURDATA",r,o,t)}catch(r){console.error("❌ Failed to load labour data:",r)}};l.useEffect(()=>{L()},[]);const Te=l.useMemo(()=>{const r=(G||"").toLowerCase();return(P||[]).filter(o=>[o.id,o.category,o.subcategory].filter(Boolean).some(t=>t.toString().toLowerCase().includes(r)))},[P,G]),Ae=l.useMemo(()=>{const r=(J||"").toLowerCase();return(D||[]).filter(o=>{const t=o.category||{};return[o.id,o.vendor,o.is_company,t.category,t.subcategory].filter(Boolean).some(a=>a.toString().toLowerCase().includes(r))})},[D,J]),Ie=()=>{re(!1),se(null),V({category:"",subcategory:""}),C(!0)},$e=r=>{re(!0),se(r),V({category:r.category||"",subcategory:r.subcategory||""}),C(!0)},Oe=async()=>{try{const r={category:U.category,subcategory:U.subcategory};T&&(I!=null&&I.id)?(await Ke(I.id,r),alert("Category updated")):(await Xe(r),alert("Category created")),C(!1),await L()}catch(r){console.error("❌ Save category failed:",r),alert("❌ Failed to save category")}},Ue=async r=>{if(window.confirm(`Delete category ID: ${r}?`))try{await Ge(r),alert("✅ Deleted"),await L()}catch(o){console.error("❌ Delete category failed:",o),alert("❌ Failed to delete category")}},Ve=()=>{oe(!1),te(null),R({category_id:"",vendor:"",is_company:!1}),b(!0)},Be=async r=>{var o;try{const t=await Je(r.id);oe(!0),te(r),R({category_id:((o=t==null?void 0:t.category)==null?void 0:o.id)||"",vendor:(t==null?void 0:t.vendor)||"",is_company:!!(t!=null&&t.is_company)}),b(!0)}catch(t){console.error("❌ Fetch resource failed:",t),alert("Failed to fetch resource details")}},We=async()=>{var r;try{const o={category_id:_.category_id,vendor:_.vendor,is_company:!!_.is_company};A&&($!=null&&$.id)?(await Ze($.id,o),alert("Resource updated")):(await De(o),alert("Resource created")),b(!1),await L()}catch(o){console.error("❌ Save resource failed:",o);const t=(r=o==null?void 0:o.response)!=null&&r.data?JSON.stringify(o.response.data):o.message;alert(`❌ Failed to save resource.
${t}`)}},ze=async r=>{if(window.confirm(`Delete labour resource ID: ${r}?`))try{await qe(r),alert("✅ Deleted"),await L()}catch(o){console.error("❌ Delete resource failed:",o),alert("❌ Failed to delete resource")}},ae=r=>{if(!r)return"-";const o=n=>typeof n=="string"?n.replace(/\w\S*/g,x=>x.charAt(0).toUpperCase()+x.slice(1).toLowerCase()):n,t=typeof r=="object"&&r!==null?r:{category:String(r)},a=o(t.category||""),v=t.subcategory?` — ${o(t.subcategory)}`:"";return`${a}${v}`};return e.jsxs(e.Fragment,{children:[e.jsxs(d,{sx:{mt:5,mb:2,display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(S,{variant:"h5",gutterBottom:!0,sx:{m:0},children:"Labour Management"}),e.jsx(g,{variant:"contained",onClick:Ee,sx:{background:"linear-gradient(90deg, #7267ef, #5e8bee)"},children:"Vendor Labour Usage Report"})]}),e.jsx(i,{container:!0,spacing:2,direction:"column",sx:{mb:2},children:e.jsx(i,{item:!0,xs:12,children:e.jsxs(E,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(S,{variant:"h6",gutterBottom:!0,children:"LABOUR CATEGORIES"}),e.jsx(d,{sx:{my:2,mx:1},children:e.jsx("input",{type:"text",placeholder:"Search Categories",value:G,onChange:r=>we(r.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4}})}),e.jsxs(z,{children:[e.jsx(N,{children:e.jsxs(j,{children:[e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"ID"})}),e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Category"})}),e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Subcategory"})}),e.jsx(s,{sx:{display:"flex",justifyContent:"flex-end",color:"#660000"},children:e.jsx("strong",{children:"Action"})})]})}),e.jsx(M,{children:(Te||[]).map(r=>e.jsxs(j,{children:[e.jsx(s,{children:r.id}),e.jsx(s,{children:(r.category||"").replace(/\w\S*/g,o=>o.charAt(0).toUpperCase()+o.slice(1).toLowerCase())}),e.jsx(s,{children:r.subcategory?r.subcategory.replace(/\w\S*/g,o=>o.charAt(0).toUpperCase()+o.slice(1).toLowerCase()):"-"}),e.jsxs(s,{sx:{display:"flex",justifyContent:"flex-end"},children:[e.jsx(B,{slug:p,action:"can_update",children:e.jsx(m,{onClick:()=>$e(r),color:"warning",children:e.jsx(ue,{sx:{color:"orange"}})})}),e.jsx(W,{slug:p,action:"can_delete",children:e.jsx(m,{onClick:()=>Ue(r.id),color:"error",children:e.jsx(ge,{sx:{color:"red"}})})})]})]},r.id))})]}),e.jsx(d,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:e.jsx(W,{slug:p,action:"can_create",children:e.jsx(g,{variant:"outlined",onClick:Ie,sx:{borderColor:"#7267ef",color:"#7267ef"},children:"Add Category"})})})]})})}),e.jsx(i,{container:!0,spacing:2,children:e.jsx(i,{item:!0,xs:12,children:e.jsxs(E,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(S,{variant:"h6",gutterBottom:!0,children:"LABOUR RESOURCES"}),e.jsx("input",{type:"text",placeholder:"Search Resources",value:J,onChange:r=>Se(r.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4,marginBottom:"16px"}}),e.jsx(Z,{sx:{maxHeight:450,overflow:"auto",border:"1px solid #ddd"},children:e.jsxs(z,{stickyHeader:!0,children:[e.jsx(N,{children:e.jsxs(j,{children:[e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"ID"})}),e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Category"})}),e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Vendor"})}),e.jsx(s,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Is Company"})}),e.jsx(s,{sx:{color:"#660000"},children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(M,{children:(Ae||[]).map(r=>e.jsxs(j,{children:[e.jsx(s,{children:r.id}),e.jsx(s,{children:ae(r.category)}),e.jsx(s,{children:r.vendor}),e.jsx(s,{children:r.is_company?"Yes":"No"}),e.jsxs(s,{children:[e.jsx(B,{slug:p,action:"can_update",children:e.jsx(m,{color:"warning",onClick:()=>Be(r),children:e.jsx(ue,{sx:{color:"orange"}})})}),e.jsx(W,{slug:p,action:"can_delete",children:e.jsx(m,{color:"error",onClick:()=>ze(r.id),children:e.jsx(ge,{sx:{color:"red"}})})})]})]},r.id))})]})}),e.jsx(d,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:e.jsx(W,{slug:p,action:"can_create",children:e.jsx(g,{variant:"outlined",onClick:Ve,sx:{borderColor:"#7267ef",color:"#7267ef"},children:"Add Resource"})})})]})})}),e.jsxs(q,{open:ke,onClose:()=>C(!1),fullWidth:!0,maxWidth:"sm",PaperProps:{style:O?{width:"100%",height:"100vh",margin:0}:{width:"60%",height:"auto"}},children:[e.jsx(K,{children:T?"Edit Category":"Create Category"}),e.jsxs(X,{sx:{position:"relative",overflowY:"auto"},children:[e.jsx(m,{"aria-label":"toggle-size",onClick:ne,sx:{position:"absolute",right:40,top:8},children:O?e.jsx(je,{}):e.jsx(pe,{})}),e.jsx(m,{"aria-label":"close",onClick:()=>C(!1),sx:{position:"absolute",right:8,top:8},children:e.jsx(xe,{})}),e.jsx(d,{sx:{mt:2},children:e.jsxs(i,{container:!0,spacing:2,children:[e.jsxs(i,{item:!0,xs:12,sm:6,children:[e.jsx("label",{htmlFor:"category",children:"Category"}),e.jsxs("select",{id:"category",name:"category",className:"input",value:U.category,onChange:r=>V(o=>({...o,category:r.target.value})),children:[e.jsx("option",{value:"",children:"Select Category"}),me.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]})]}),e.jsxs(i,{item:!0,xs:12,sm:6,children:[e.jsx("label",{htmlFor:"subcategory",children:"Subcategory"}),e.jsx("input",{id:"subcategory",name:"subcategory",className:"input",value:U.subcategory,onChange:r=>V(o=>({...o,subcategory:r.target.value}))})]})]})})]}),e.jsxs(Q,{children:[e.jsx(g,{onClick:()=>C(!1),sx:{outline:"2px solid #800000",color:"#800000"},children:"Cancel"}),e.jsx(B,{slug:p,action:T?"can_update":"can_create",children:e.jsx(g,{variant:"outlined",onClick:Oe,sx:{borderColor:"#7267ef",color:"#7267ef"},children:T?"Update Category":"Submit Category"})})]})]}),e.jsxs(q,{open:be,onClose:()=>Y(!1),fullWidth:!0,maxWidth:"lg",children:[e.jsx(K,{children:"Vendor-Level Labour Usage Report"}),e.jsxs(X,{dividers:!0,children:[e.jsxs(i,{container:!0,spacing:2,alignItems:"center",sx:{mb:1},children:[e.jsxs(i,{item:!0,xs:12,sm:6,md:4,children:[e.jsx("label",{htmlFor:"vendorFilter",children:"Filter by Vendor"}),e.jsxs("select",{id:"vendorFilter",className:"input",value:f,onChange:r=>ve(r.target.value),style:{width:"100%",padding:8,border:"1px solid #ccc",borderRadius:4},children:[e.jsx("option",{value:"",children:"All Vendors"}),(H||[]).map(r=>e.jsxs("option",{value:r.vendor_id,children:[r.vendor_id," ",r.vendor_name?`— ${r.vendor_name}`:""]},r.vendor_id))]})]}),e.jsxs(i,{item:!0,xs:12,sm:6,md:8,sx:{display:"flex",justifyContent:{xs:"flex-start",sm:"flex-end"},gap:1},children:[e.jsx(g,{variant:"outlined",onClick:le,disabled:F,children:F?"Loading…":"Generate"}),e.jsx(g,{variant:"contained",onClick:Fe,disabled:F||!k.length,children:"Download PDF"})]})]}),F?e.jsx(S,{variant:"body2",color:"text.secondary",children:"Loading report…"}):e.jsx(d,{children:k.length===0?e.jsx(S,{variant:"body2",color:"text.secondary",children:"No data"}):e.jsx(i,{container:!0,spacing:2,children:k.map((r,o)=>e.jsx(i,{item:!0,xs:12,children:e.jsxs(E,{sx:{p:2,border:"1px solid #e5e7eb",borderRadius:2},children:[e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:1},children:[e.jsxs(S,{variant:"subtitle1",sx:{fontWeight:600},children:[r.vendor_name||"Unknown Vendor"," ",r.vendor_id?`(${r.vendor_id})`:""]}),e.jsxs(d,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsxs(d,{className:"chip",children:["Total Workers: ",r.total_workers??"-"]}),e.jsxs(d,{className:"chip",children:["Total Hours: ",r.total_work_hours??"-"]}),e.jsxs(d,{className:"chip",children:["Total Effort: ",r.total_effort??"-"]})]})]}),r.categories?e.jsx(Z,{component:E,sx:{mt:1,boxShadow:"none",border:"1px solid #eee"},children:e.jsxs(z,{size:"small",children:[e.jsx(N,{children:e.jsxs(j,{children:[e.jsx(s,{children:"Category"}),e.jsx(s,{children:"Subcategory"}),e.jsx(s,{children:"Total Workers"}),e.jsx(s,{children:"Entries"})]})}),e.jsx(M,{children:Object.entries(r.categories).map(([t,a])=>{const v=a!=null&&a.subcategories?Object.entries(a.subcategories):[];return v.length?v.map(([n,x])=>e.jsxs(j,{children:[e.jsx(s,{children:u(t)}),e.jsx(s,{children:u(n)}),e.jsx(s,{children:(x==null?void 0:x.total_workers)??"-"}),e.jsx(s,{children:((x==null?void 0:x.details)||[]).length})]},`${t}-${n}`)):e.jsxs(j,{children:[e.jsx(s,{children:u(t)}),e.jsx(s,{children:"—"}),e.jsx(s,{children:(a==null?void 0:a.total_workers)??"-"}),e.jsx(s,{children:"—"})]},`${t}-row`)})})]})}):null,e.jsx(Z,{component:E,sx:{mt:1,boxShadow:"none",border:"1px solid #eee"},children:e.jsxs(z,{size:"small",children:[e.jsx(N,{children:e.jsxs(j,{children:[e.jsx(s,{children:"Site"}),e.jsx(s,{children:"Project"}),e.jsx(s,{children:"Category"}),e.jsx(s,{children:"Subcategory"}),e.jsx(s,{children:"# Workers"}),e.jsx(s,{children:"Hours"}),e.jsx(s,{children:"Total Effort"}),e.jsx(s,{children:"Date"})]})}),e.jsx(M,{children:(r.details||[]).map((t,a)=>e.jsxs(j,{children:[e.jsx(s,{children:t.site_execution||"-"}),e.jsx(s,{children:t.project||"-"}),e.jsx(s,{children:u(t.category||"-")}),e.jsx(s,{children:u(t.subcategory||"-")}),e.jsx(s,{children:t.number_of_workers??"-"}),e.jsx(s,{children:t.work_hours??"-"}),e.jsx(s,{children:t.total_effort??"-"}),e.jsx(s,{children:t.date?new Date(t.date).toLocaleString():"-"})]},a))})]})})]})},o))})})]}),e.jsx(Q,{children:e.jsx(g,{onClick:()=>Y(!1),children:"Close"})})]}),e.jsxs(q,{open:Re,onClose:()=>b(!1),fullWidth:!0,maxWidth:"sm",PaperProps:{style:O?{width:"100%",height:"100vh",margin:0}:{width:"60%",height:"auto"}},children:[e.jsx(K,{children:A?"Edit Labour Resource":"Create Labour Resource"}),e.jsxs(X,{sx:{position:"relative",overflowY:"auto"},children:[e.jsx(m,{"aria-label":"toggle-size",onClick:ne,sx:{position:"absolute",right:40,top:8},children:O?e.jsx(je,{}):e.jsx(pe,{})}),e.jsx(m,{"aria-label":"close",onClick:()=>b(!1),sx:{position:"absolute",right:8,top:8},children:e.jsx(xe,{})}),e.jsx(d,{sx:{mt:2},children:e.jsxs(i,{container:!0,spacing:2,children:[e.jsxs(i,{item:!0,xs:12,sm:6,children:[e.jsx("label",{htmlFor:"category_id",children:"Category"}),e.jsxs("select",{id:"category_id",name:"category_id",className:"input",value:_.category_id,onChange:r=>R(o=>({...o,category_id:r.target.value})),children:[e.jsx("option",{value:"",children:"Select Category"}),(P||[]).map(r=>e.jsx("option",{value:r.id,children:ae(r)},r.id))]})]}),e.jsxs(i,{item:!0,xs:12,sm:6,children:[e.jsx("label",{htmlFor:"vendor",children:"Vendor"}),e.jsxs("select",{id:"vendor",name:"vendor",className:"input",value:_.vendor,onChange:r=>R(o=>({...o,vendor:r.target.value})),children:[e.jsx("option",{value:"",children:"Select Vendor"}),(H||[]).map(r=>e.jsxs("option",{value:r.vendor_id,children:[r.vendor_id," ",r.vendor_name?`— ${r.vendor_name}`:""]},r.vendor_id))]})]}),e.jsxs(i,{item:!0,xs:12,sm:6,children:[e.jsx("label",{htmlFor:"is_company",style:{display:"inline-flex",alignItems:"center",gap:8},children:"Is Company?"}),e.jsx(or,{id:"is_company",checked:!!_.is_company,onChange:r=>R(o=>({...o,is_company:r.target.checked}))})]})]})})]}),e.jsxs(Q,{children:[e.jsx(g,{onClick:()=>b(!1),sx:{outline:"2px solid #800000",color:"#800000"},children:"Cancel"}),e.jsx(B,{slug:p,action:A?"can_update":"can_create",children:e.jsx(g,{variant:"outlined",onClick:We,sx:{borderColor:"#7267ef",color:"#7267ef"},children:A?"Update Resource":"Submit Resource"})})]})]})]})};export{yr as default};
