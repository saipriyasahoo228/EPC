import{k as ze,i as He,r as l,m as Be,j as e,o as Ce,n as ye,t as We,L as at,w as it,O as Z,E,T as d,J as H,K as q,S as lt,I as Ne,Q as ct}from"./main-Skim5IJC.js";import{C as ke}from"./Close-BKZ7QrSY.js";import{f as dt,g as Q,a as ut,h as xt,i as ht,j as pt}from"./tenderAllocation-fUAxLPxU.js";import{g as mt,a as jt}from"./user-h3xj2oLf.js";import{f as R}from"./date-DdrLtg20.js";import{T as gt}from"./Tooltip-YrZkw7B4.js";import{B as g,D as ce,a as de,b as ue,c as ft}from"./DialogTitle-CvDFHAwp.js";import{T as xe}from"./TableContainer-gCCy6yK7.js";import{T as he,a as pe,b as A,c as a,d as me}from"./TableRow-B6k_bSOs.js";import{C as yt}from"./Chip-DTcaVcsg.js";import{T as Ct}from"./TablePagination-_dHW1U1A.js";import{i as bt,G as m}from"./Grid-fY_ATwTx.js";import{T as vt}from"./TextField-D43kg6c3.js";import{L as X,i as Te,a as Me}from"./Select-BThNtn2k.js";import{l as St,L as je}from"./ListItemText-DGUSFsAP.js";import{C as It}from"./Checkbox-pnRANLqZ.js";import{D as Dt}from"./Divider-mutym74u.js";import"./index-Pp9EW3wT.js";import"./useControlled-CHkDrNg3.js";import"./useSlotProps-CCL6Y0ZK.js";import"./KeyboardArrowRight-BzCb_W4p.js";import"./MenuItem-Cm5ZuES4.js";import"./Toolbar-Dufg8Txv.js";import"./useFormControl-C6hS7-Rn.js";function At(o){return ze("MuiListItem",o)}He("MuiListItem",["root","container","dense","alignItemsFlexStart","divider","gutters","padding","secondaryAction"]);function _t(o){return ze("MuiListItemSecondaryAction",o)}He("MuiListItemSecondaryAction",["root","disableGutters"]);const wt=o=>{const{disableGutters:n,classes:c}=o;return We({root:["root",n&&"disableGutters"]},_t,c)},Pt=Ce("div",{name:"MuiListItemSecondaryAction",slot:"Root",overridesResolver:(o,n)=>{const{ownerState:c}=o;return[n.root,c.disableGutters&&n.disableGutters]}})({position:"absolute",right:16,top:"50%",transform:"translateY(-50%)",variants:[{props:({ownerState:o})=>o.disableGutters,style:{right:0}}]}),$e=l.forwardRef(function(n,c){const s=Be({props:n,name:"MuiListItemSecondaryAction"}),{className:h,...p}=s,f=l.useContext(X),y={...s,disableGutters:f.disableGutters},S=wt(y);return e.jsx(Pt,{className:ye(S.root,h),ownerState:y,ref:c,...p})});$e.muiName="ListItemSecondaryAction";const Lt=(o,n)=>{const{ownerState:c}=o;return[n.root,c.dense&&n.dense,c.alignItems==="flex-start"&&n.alignItemsFlexStart,c.divider&&n.divider,!c.disableGutters&&n.gutters,!c.disablePadding&&n.padding,c.hasSecondaryAction&&n.secondaryAction]},Rt=o=>{const{alignItems:n,classes:c,dense:s,disableGutters:h,disablePadding:p,divider:f,hasSecondaryAction:y}=o;return We({root:["root",s&&"dense",!h&&"gutters",!p&&"padding",f&&"divider",n==="flex-start"&&"alignItemsFlexStart",y&&"secondaryAction"],container:["container"]},At,c)},Ut=Ce("div",{name:"MuiListItem",slot:"Root",overridesResolver:Lt})(it(({theme:o})=>({display:"flex",justifyContent:"flex-start",alignItems:"center",position:"relative",textDecoration:"none",width:"100%",boxSizing:"border-box",textAlign:"left",variants:[{props:({ownerState:n})=>!n.disablePadding,style:{paddingTop:8,paddingBottom:8}},{props:({ownerState:n})=>!n.disablePadding&&n.dense,style:{paddingTop:4,paddingBottom:4}},{props:({ownerState:n})=>!n.disablePadding&&!n.disableGutters,style:{paddingLeft:16,paddingRight:16}},{props:({ownerState:n})=>!n.disablePadding&&!!n.secondaryAction,style:{paddingRight:48}},{props:({ownerState:n})=>!!n.secondaryAction,style:{[`& > .${St.root}`]:{paddingRight:48}}},{props:{alignItems:"flex-start"},style:{alignItems:"flex-start"}},{props:({ownerState:n})=>n.divider,style:{borderBottom:`1px solid ${(o.vars||o).palette.divider}`,backgroundClip:"padding-box"}},{props:({ownerState:n})=>n.button,style:{transition:o.transitions.create("background-color",{duration:o.transitions.duration.shortest}),"&:hover":{textDecoration:"none",backgroundColor:(o.vars||o).palette.action.hover,"@media (hover: none)":{backgroundColor:"transparent"}}}},{props:({ownerState:n})=>n.hasSecondaryAction,style:{paddingRight:48}}]}))),Nt=Ce("li",{name:"MuiListItem",slot:"Container",overridesResolver:(o,n)=>n.container})({position:"relative"}),ge=l.forwardRef(function(n,c){const s=Be({props:n,name:"MuiListItem"}),{alignItems:h="center",children:p,className:f,component:y,components:S={},componentsProps:B={},ContainerComponent:_="li",ContainerProps:{className:U,...ee}={},dense:W=!1,disableGutters:N=!1,disablePadding:O=!1,divider:te=!1,secondaryAction:k,slotProps:$={},slots:T={},...se}=s,u=l.useContext(X),M=l.useMemo(()=>({dense:W||u.dense||!1,alignItems:h,disableGutters:N}),[h,u.dense,W,N]),ne=l.useRef(null),C=l.Children.toArray(p),I=C.length&&bt(C[C.length-1],["ListItemSecondaryAction"]),w={...s,alignItems:h,dense:M.dense,disableGutters:N,disablePadding:O,divider:te,hasSecondaryAction:I},F=Rt(w),Y=at(ne,c),G=T.root||S.Root||Ut,P=$.root||B.root||{},D={className:ye(F.root,P.className,f),...se};let b=y||"li";return I?(b=!D.component&&!y?"div":b,_==="li"&&(b==="li"?b="div":D.component==="li"&&(D.component="div")),e.jsx(X.Provider,{value:M,children:e.jsxs(Nt,{as:_,className:ye(F.container,U),ref:Y,ownerState:w,...ee,children:[e.jsx(G,{...P,...!Te(G)&&{as:b,ownerState:{...w,...P.ownerState}},...D,children:C}),C.pop()]})})):e.jsx(X.Provider,{value:M,children:e.jsxs(G,{...P,as:b,ref:Y,...!Te(G)&&{ownerState:{...w,...P.ownerState}},...D,children:[C,k&&e.jsx($e,{children:k})]})})}),Ee=Z(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"})),Oe=Z(e.jsx("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2m5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12z"})),Fe=Z(e.jsx("path",{d:"M6 2v6h.01L6 8.01 10 12l-4 4 .01.01H6V22h12v-5.99h-.01L18 16l-4-4 4-3.99-.01-.01H18V2zm10 14.5V20H8v-3.5l4-4zm-4-5-4-4V4h8v3.5z"})),kt=Z(e.jsx("path",{d:"M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9m-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8z"})),x=[];for(let o=0;o<256;++o)x.push((o+256).toString(16).slice(1));function Tt(o,n=0){return(x[o[n+0]]+x[o[n+1]]+x[o[n+2]]+x[o[n+3]]+"-"+x[o[n+4]]+x[o[n+5]]+"-"+x[o[n+6]]+x[o[n+7]]+"-"+x[o[n+8]]+x[o[n+9]]+"-"+x[o[n+10]]+x[o[n+11]]+x[o[n+12]]+x[o[n+13]]+x[o[n+14]]+x[o[n+15]]).toLowerCase()}let fe;const Mt=new Uint8Array(16);function Et(){if(!fe){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");fe=crypto.getRandomValues.bind(crypto)}return fe(Mt)}const Ot=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ge={randomUUID:Ot};function Ve(o,n,c){var h;if(Ge.randomUUID&&!o)return Ge.randomUUID();o=o||{};const s=o.random??((h=o.rng)==null?void 0:h.call(o))??Et();if(s.length<16)throw new Error("Random bytes length must be >= 16");return s[6]=s[6]&15|64,s[8]=s[8]&63|128,Tt(s)}const us=()=>{var _e,we,Pe,Le,Re,Ue;const o="tender_allocation";new Date().toISOString().split("T")[0];const[n,c]=l.useState([]),[s,h]=l.useState(null),[p,f]=l.useState(null),[y,S]=l.useState(!1),[B,_]=l.useState([]),[U,ee]=l.useState([]),[W,N]=l.useState(!1),[O,te]=l.useState(""),[k,$]=l.useState(0),[T,se]=l.useState(5),[u,M]=l.useState({jobAllocationDate:"",govtProjectId:"",projectId:Ve(),allocationStatus:"Allocated",refundDate:"",cancellationNote:""}),[ne,C]=l.useState(!1),[I,w]=l.useState(null),[F,Y]=l.useState([]),[G,P]=l.useState([]),[D,b]=l.useState(""),[J,be]=l.useState(new Set),[Ft,Ye]=l.useState(null),[Gt,Je]=l.useState({}),Ke=l.useRef(),ve=l.useRef(),Se=l.useRef(),K=l.useRef(),V=l.useRef(),qe=n.filter(t=>t.tenderId.toLowerCase().includes(O.toLowerCase())||t.title.toLowerCase().includes(O.toLowerCase())),Qe=(t,i)=>{$(i)},Xe=t=>{se(parseInt(t.target.value,10)),$(0)},Ie=B.slice(k*T,k*T+T);l.useEffect(()=>{const t=async()=>{try{const j=(await ut()).map(v=>({tenderId:v.tender_id,title:v.tender_ref_no||"Untitled Tender",status:v.status||""}));c(j)}catch(r){console.error("Error fetching tenders:",r)}},i=async()=>{try{const r=await Q();_(r),console.log(r)}catch(r){console.error("Error fetching projects:",r)}};t(),i()},[]);const Ze=(t,i,r={})=>{const j={id:Ve(),timestamp:new Date().toISOString(),action:t,tenderId:i,user:"currentUser",details:r};ee(v=>[...v,j])},et=async t=>{w(t),C(!0);const i=new Set((t.users||[]).map(r=>typeof r=="string"?r:r==null?void 0:r.user_id).filter(Boolean));be(i);try{const[r,j]=await Promise.all([mt(),jt()]);Y(Array.isArray(r)?r:[]),P(Array.isArray(j)?j:[])}catch(r){console.error("Failed to fetch users/groups",r)}},oe=()=>{C(!1),w(null),b(""),Ye(null),Je({})},De=t=>{be(i=>{const r=new Set([...i]);return r.has(String(t))?r.delete(String(t)):r.add(String(t)),r})},tt=t=>t!=null&&t.role?t.role:t!=null&&t.is_admin?"Admin":"User",st=t=>(t||"").replace(/\b\w/g,i=>i.toUpperCase()),re=async(t,i)=>{if(f(t),S(!0),t==="accept"&&h(i),t==="view")try{const r=await xt(i.tenderId);h(r),Ze("Viewed tender details",i.tenderId)}catch(r){console.error("Error fetching tender by ID:",r),alert("Failed to fetch tender details.")}t==="cancel"&&h(i)},ae=()=>{S(!1),f(null),h(null)},z=t=>i=>{M({...u,[t]:i.target.value})},ie=(t,i)=>{var r;t.key==="Enter"&&(t.preventDefault(),(r=i==null?void 0:i.current)==null||r.focus())},nt=async()=>{var t,i;try{if(!s)return;if(p==="accept"){const r={status:"Accept",job_allocation_date:u.jobAllocationDate,govt_project_id:u.govtProjectId,allocation_state:u.allocationStatus},j=await ht(s.tenderId,r);console.log("Project created successfully:",j),alert(`Project ${j.project_id} created successfully!`),c(le=>le.map(L=>L.tenderId===s.tenderId?{...L,status:"Accept"}:L));const v=await Q();_(v)}if(p==="cancel"){if(!u.refundDate||!u.cancellationNote){alert("Please fill in Security Money Refund Date and Cancellation Notes."),u.refundDate?(i=V==null?void 0:V.current)==null||i.focus():(t=K==null?void 0:K.current)==null||t.focus();return}const r={status:"Cancel",security_money_refund_date:u.refundDate,description:u.cancellationNote},j=await pt(s.tenderId,r);console.log("Tender cancelled successfully:",j),alert("Tender cancelled successfully!"),c(le=>le.map(L=>L.tenderId===s.tenderId?{...L,status:"Cancel"}:L));const v=await Q();_(v)}M({jobAllocationDate:"",govtProjectId:"",projectId:"",allocationStatus:"Allocated",refundDate:"",cancellationNote:""}),S(!1),h(null),f(null)}catch(r){console.error("Error submitting:",r),alert("Submission failed. Please check data and try again.")}},ot=t=>{switch(t){case"accepted":return e.jsx(Ee,{color:"success"});case"cancelled":return e.jsx(Oe,{color:"error"});default:return e.jsx(Fe,{color:"disabled"})}},rt=()=>{N(!0)},Ae=()=>{N(!1)};return e.jsxs("div",{style:{padding:"1rem",position:"relative"},children:[e.jsxs(E,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:2,mb:2},children:[e.jsx(d,{variant:"h6",sx:{color:"#7267ef"},children:"TENDER STATUS FOR PROJECT CREATION"}),e.jsx(gt,{title:"View Audit Trail",children:e.jsxs(g,{variant:"outlined",startIcon:e.jsx(kt,{}),onClick:rt,disabled:U.length===0,sx:{borderColor:"#7267ef",color:"#7267ef","&:hover":{borderColor:"#5a55d7",backgroundColor:"#e0e0f7"}},children:["Audit Trail (",U.length,")"]})})]}),e.jsxs(xe,{component:H,sx:{border:"1px solid #7267ef"},children:[e.jsx(E,{mx:2,my:1,children:e.jsx("input",{type:"text",placeholder:"Search Tenders",value:O,onChange:t=>te(t.target.value),className:"input"})}),e.jsxs(he,{children:[e.jsx(pe,{children:e.jsxs(A,{children:[e.jsx(a,{sx:{color:"#7267ef"},children:"Status"}),e.jsx(a,{sx:{color:"#7267ef"},children:"Tender ID"}),e.jsx(a,{sx:{color:"#7267ef"},children:"Tender Ref.No"}),e.jsx(a,{align:"center",sx:{paddingLeft:"160px",color:"#800000"},children:"Actions"})]})}),e.jsx(me,{children:qe.map(t=>e.jsxs(A,{children:[e.jsx(a,{children:ot(t.status)}),e.jsx(a,{children:t.tenderId}),e.jsx(a,{children:t.title}),e.jsx(a,{align:"right",children:e.jsxs(E,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(g,{variant:"outlined",onClick:()=>re("view",t),sx:{borderColor:"#7267ef",color:"#7267ef","&:hover":{borderColor:"#5a55d7",backgroundColor:"#e0e0f7"}},children:"View"}),e.jsx(q,{slug:o,action:"can_create",children:e.jsx(g,{variant:"contained",color:"success",onClick:()=>re("accept",t),children:"Accept"})}),e.jsx(q,{slug:o,action:"can_update",children:e.jsx(g,{variant:"contained",color:"error",onClick:()=>re("cancel",t),children:"Cancel"})})]})})]},t.tenderId))})]})]}),e.jsxs(E,{mt:4,children:[e.jsx(d,{variant:"h6",sx:{color:"#7267ef",mb:1},children:"PROJECT ALLOCATION REPORT"}),e.jsxs(xe,{component:H,sx:{border:"1px solid #7267ef"},children:[e.jsxs(he,{children:[e.jsx(pe,{children:e.jsxs(A,{children:[e.jsx(a,{sx:{color:"#7267ef"},children:"Tender ID"}),e.jsx(a,{sx:{color:"#7267ef"},children:"Project ID"}),e.jsx(a,{sx:{color:"#7267ef"},children:"Govt Project ID"}),e.jsx(a,{sx:{color:"#7267ef"},children:"Job Allocation Date"}),e.jsx(a,{sx:{color:"#7267ef"},children:"Allocation State"}),e.jsx(a,{sx:{color:"#7267ef"},children:"Security Deposit Refund Date"}),e.jsx(a,{sx:{color:"#7267ef"},children:"Security Money Amount"}),e.jsx(a,{sx:{color:"#7267ef"},children:"Cancellation Note"}),e.jsx(a,{sx:{color:"#7267ef"},children:"Status"}),e.jsx(a,{sx:{color:"#7267ef"},children:"Users"})]})}),e.jsx(me,{children:Ie.length>0?Ie.map(t=>e.jsxs(A,{children:[e.jsx(a,{children:t.tender}),e.jsx(a,{children:t.project_id||"-"}),e.jsx(a,{children:t.govt_project_id||"-"}),e.jsx(a,{children:t.job_allocation_date?R(t.job_allocation_date):"-"}),e.jsx(a,{children:t.allocation_state||"-"}),e.jsx(a,{children:t.security_money_refund_date?R(t.security_money_refund_date):"-"}),e.jsx(a,{children:t.security_money_amount||"-"}),e.jsx(a,{children:t.description||"-"}),e.jsx(a,{children:t.status==="Accept"?e.jsx(Ee,{color:"success"}):t.status==="Cancel"?e.jsx(Oe,{color:"error"}):e.jsx(Fe,{color:"disabled"})}),e.jsx(a,{align:"right",children:e.jsxs(E,{sx:{display:"flex",gap:1,justifyContent:"flex-end",alignItems:"center"},children:[e.jsx(yt,{size:"small",label:`${(t.users||[]).length} users`}),e.jsx(lt,{slug:o,action:"can_update",children:e.jsx(g,{variant:"outlined",onClick:()=>et(t),children:"Allocate"})})]})})]},t.id)):e.jsx(A,{children:e.jsx(a,{colSpan:8,align:"center",children:"No project records found."})})})]}),e.jsx(Ct,{rowsPerPageOptions:[5,10,25],component:"div",count:B.length,rowsPerPage:T,page:k,onPageChange:Qe,onRowsPerPageChange:Xe})]})]}),e.jsxs(ce,{open:y,onClose:ae,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(de,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[p==="accept"?"Project Allocation Details":p==="cancel"?"Cancellation Details":"Tender Details",e.jsx(Ne,{onClick:ae,children:e.jsx(ke,{})})]}),e.jsxs(ue,{children:[p==="view"?e.jsxs(e.Fragment,{children:[e.jsxs(d,{children:[e.jsx("strong",{children:"Tender ID:"})," ",s==null?void 0:s.tender_id]}),e.jsxs(d,{children:[e.jsx("strong",{children:"Reference No:"})," ",s==null?void 0:s.tender_ref_no]}),e.jsxs(d,{children:[e.jsx("strong",{children:"Location:"})," ",s==null?void 0:s.location]}),e.jsxs(d,{children:[e.jsx("strong",{children:"Release Date:"})," ",R(s==null?void 0:s.release_date)]}),e.jsxs(d,{children:[e.jsx("strong",{children:"Tender Value:"})," ₹",s==null?void 0:s.tender_value]}),e.jsx(d,{children:e.jsx("strong",{children:"EMD Details:"})}),e.jsxs("ul",{style:{margin:0,paddingLeft:"1.2rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Amount:"})," ₹",(_e=s==null?void 0:s.emd_details)==null?void 0:_e.amount]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Validity:"})," ",R((we=s==null?void 0:s.emd_details)==null?void 0:we.validity)]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Conditions:"})," ",(Pe=s==null?void 0:s.emd_details)==null?void 0:Pe.conditions]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Refund Date:"})," ",(Le=s==null?void 0:s.emd_details)!=null&&Le.refund_date?R((Re=s==null?void 0:s.emd_details)==null?void 0:Re.refund_date):"-"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Is Refunded:"})," ",typeof((Ue=s==null?void 0:s.emd_details)==null?void 0:Ue.is_refunded)=="boolean"?s.emd_details.is_refunded?"Yes":"No":"-"]})]}),e.jsxs(d,{children:[e.jsx("strong",{children:"Authority:"})," ",s==null?void 0:s.authority]}),e.jsxs(d,{children:[e.jsx("strong",{children:"Contact:"})," ",s==null?void 0:s.contact]}),e.jsxs(d,{children:[e.jsx("strong",{children:"Authorized Personnel:"})," ",s==null?void 0:s.authorized_personnel]}),e.jsxs(d,{children:[e.jsx("strong",{children:"Start Date:"})," ",R(s==null?void 0:s.start_date)]}),e.jsxs(d,{children:[e.jsx("strong",{children:"End Date:"})," ",R(s==null?void 0:s.end_date)]}),e.jsxs(d,{children:[e.jsx("strong",{children:"Description:"})," ",s==null?void 0:s.tender_description]}),e.jsxs(d,{children:[e.jsx("strong",{children:"Status:"})," ",s==null?void 0:s.status]})]}):p==="accept"?e.jsx(e.Fragment,{children:e.jsxs(m,{container:!0,spacing:2,sx:{mt:1},children:[e.jsxs(m,{item:!0,xs:12,children:[e.jsxs("label",{htmlFor:"jobAllocationDate",children:["Job Allocation Date ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("input",{type:"date",id:"jobAllocationDate",value:u.jobAllocationDate,onChange:z("jobAllocationDate"),onKeyDown:t=>ie(t,ve),ref:Ke,className:"input"})]}),e.jsxs(m,{item:!0,xs:12,children:[e.jsxs("label",{htmlFor:"govtProjectId",children:["Govt. Project ID ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("input",{type:"text",id:"govtProjectId",value:u.govtProjectId,onChange:z("govtProjectId"),onKeyDown:t=>ie(t,Se),ref:ve,className:"input"})]}),e.jsxs(m,{item:!0,xs:12,children:[e.jsxs("label",{htmlFor:"allocationStatus",children:["Status ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsxs("select",{id:"allocationStatus",value:u.allocationStatus,onChange:z("allocationStatus"),ref:Se,className:"input",children:[e.jsx("option",{value:"Allocated",children:"Allocated"}),e.jsx("option",{value:"Not Allocated",children:"Not Allocated"})]})]})]})}):e.jsxs(m,{container:!0,spacing:2,sx:{mt:1},children:[e.jsxs(m,{item:!0,xs:12,children:[e.jsxs("label",{htmlFor:"refundDate",children:["Security Money Refund Date ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("input",{type:"date",id:"refundDate",value:u.refundDate,onChange:z("refundDate"),onKeyDown:t=>ie(t,V),ref:K,className:"input"})]}),e.jsxs(m,{item:!0,xs:12,children:[e.jsxs("label",{htmlFor:"cancellationNote",children:["Cancellation Notes ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("textarea",{id:"cancellationNote",rows:3,value:u.cancellationNote,onChange:z("cancellationNote"),ref:V,className:"input"})]})]}),p!=="view"&&e.jsxs(m,{container:!0,justifyContent:"flex-end",spacing:2,sx:{mt:2},children:[e.jsx(m,{item:!0,children:e.jsx(g,{onClick:ae,variant:"outlined",sx:{borderColor:"darkred",color:"darkred","&:hover":{borderColor:"darkred",backgroundColor:"rgba(139, 0, 0, 0.1)"}},children:"Close"})}),e.jsx(m,{item:!0,children:e.jsx(q,{slug:o,action:p==="accept"?"can_create":"can_update",children:e.jsx(g,{onClick:nt,variant:"outlined",sx:{borderColor:"#7267ef",color:"#7267ef","&:hover":{color:"#7267ef"}},children:"Submit"})})})]})]})]}),e.jsxs(ce,{open:ne,onClose:oe,maxWidth:"md",fullWidth:!0,children:[e.jsxs(de,{children:["Allocate Users to Project ",(I==null?void 0:I.project_id)||""]}),e.jsx(ue,{children:e.jsxs(m,{container:!0,spacing:2,children:[e.jsxs(m,{item:!0,xs:12,md:5,children:[e.jsx(d,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"All Users"}),e.jsx(vt,{fullWidth:!0,size:"small",placeholder:"Search users by name, username or code",value:D,onChange:t=>b(t.target.value),sx:{mb:1}}),e.jsx(H,{variant:"outlined",sx:{maxHeight:360,overflow:"auto"},children:e.jsx(Me,{dense:!0,children:(F||[]).filter(t=>{const i=D.trim().toLowerCase();return i?[t.user_id,t.full_name,t.email,t.mobile_number,t.role,...Array.isArray(t.groups)?t.groups:[]].filter(Boolean).join(" ").toLowerCase().includes(i):!0}).map(t=>{const i=J.has(String(t.user_id));return e.jsxs(ct.Fragment,{children:[e.jsxs(ge,{button:!0,onClick:()=>De(t.user_id),children:[e.jsx(It,{edge:"start",checked:i,tabIndex:-1,disableRipple:!0}),e.jsx(je,{primary:`${t.full_name||"-"}`,secondary:e.jsx(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:e.jsx(d,{variant:"caption",color:"text.secondary",children:`${t.user_id} ${t.email||""}`})})})]}),e.jsx(Dt,{})]},t.user_id)})})})]}),e.jsxs(m,{item:!0,xs:12,md:7,children:[e.jsx(d,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Allocated to this Project"}),e.jsx(H,{variant:"outlined",sx:{maxHeight:420,overflow:"auto"},children:e.jsxs(Me,{dense:!0,children:[(F||[]).filter(t=>J.has(String(t.user_id))).map(t=>e.jsx(ge,{secondaryAction:e.jsx(g,{size:"small",onClick:()=>De(t.user_id),children:"Remove"}),alignItems:"flex-start",sx:{pr:2,"& .MuiListItemSecondaryAction-root":{right:8}},children:e.jsx(je,{primary:`${t.full_name||t.user_id}`,secondary:st(tt(t)),primaryTypographyProps:{noWrap:!0},secondaryTypographyProps:{noWrap:!0},sx:{pr:12,overflow:"hidden","& .MuiListItemText-primary, & .MuiListItemText-secondary":{textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap",display:"block"}}})},`sel-${t.user_id}`)),Array.from(J).length===0&&e.jsx(ge,{children:e.jsx(je,{primary:"No users allocated yet."})})]})})]})]})}),e.jsxs(ft,{children:[e.jsx(g,{onClick:oe,children:"Close"}),e.jsx(q,{slug:o,action:"can_update",children:e.jsx(g,{variant:"contained",sx:{backgroundColor:"#7267ef"},onClick:async()=>{if(I)try{const t=Array.from(J);await dt(I.project_id,{users:t});const i=await Q();_(i),alert("Users allocated successfully."),oe()}catch(t){console.error("Failed to save allocation",t),alert("Failed to save allocation. Please try again.")}},children:"Save Allocation"})})]})]}),e.jsxs(ce,{open:W,onClose:Ae,maxWidth:"md",fullWidth:!0,children:[e.jsxs(de,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:["System Audit Trail",e.jsx(Ne,{onClick:Ae,children:e.jsx(ke,{})})]}),e.jsx(ue,{children:e.jsx(xe,{component:H,sx:{mt:2},children:e.jsxs(he,{children:[e.jsx(pe,{children:e.jsxs(A,{children:[e.jsx(a,{children:"Timestamp"}),e.jsx(a,{children:"Tender ID"}),e.jsx(a,{children:"Action"}),e.jsx(a,{children:"Details"}),e.jsx(a,{children:"User"})]})}),e.jsx(me,{children:U.length>0?[...U].reverse().map(t=>e.jsxs(A,{children:[e.jsx(a,{children:new Date(t.timestamp).toLocaleString()}),e.jsx(a,{children:t.tenderId}),e.jsx(a,{children:t.action}),e.jsx(a,{children:t.details&&Object.keys(t.details).length>0?e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:Object.entries(t.details).map(([i,r])=>e.jsxs("li",{children:[e.jsxs("strong",{children:[i,":"]})," ",r]},i))}):"-"}),e.jsx(a,{children:t.user})]},t.id)):e.jsx(A,{children:e.jsx(a,{colSpan:5,align:"center",children:"No audit records found"})})})]})})})]})]})};export{us as default};
