import{r as a,j as e,T as I,x as N,S as R,D as k}from"./main-BIxdd69i.js";import{C as te}from"./Close-D340Gps3.js";import{g as re}from"./engineering-4VzvUWDc.js";import{r as ne,s as se,t as ie,v as ae}from"./construction-TCh-rxln.js";import{G as s}from"./Grid-BnZNKmae.js";import{P as A,I as u,D as oe,f as ce,g as le,h as de,e as B}from"./DialogTitle-D59uELMl.js";import{T as L,a as O,b as g,c as n,d as xe}from"./TableRow-D8X36zJO.js";import{A as he}from"./AddCircle-Bn9h5MaP.js";import{T as ue}from"./TableContainer-1Xqyy-f8.js";import{E as je}from"./Edit-BJV-h6Li.js";import{D as pe}from"./Delete-BHKbKfZ2.js";import{M as fe,a as me}from"./minimize-2-Dl_U24Qm.js";const Pe=()=>{const j="construction",[y,Y]=a.useState(!1),[_,$]=a.useState(""),[b,z]=a.useState(""),[G,S]=a.useState(!1),[C,M]=a.useState(""),[i,x]=a.useState({}),[H,ge]=a.useState([]),[U,w]=a.useState(!1),[ye,T]=a.useState(null),[Q,W]=a.useState([]),[v,E]=a.useState([]),[p,J]=a.useState(null),q=()=>{Y(!y)};a.useEffect(()=>{(async()=>{try{const r=await re();W(r)}catch(r){console.error("Error fetching projects:",r)}})()},[]),a.useEffect(()=>{F()},[]);const F=async()=>{try{const t=await ne();E(t)}catch(t){console.error("âŒ Error fetching safety records:",t)}},K=t=>{console.log("handleOpenForm called with projectId:",t),console.log("Current safetyRecords data:",v),M(t);const r=new Date().getFullYear(),c=v.filter(o=>o.safety_report_id&&o.safety_report_id.includes(`-${r}-`)).map(o=>{const P=o.safety_report_id.split("-"),ee=P[P.length-1];return parseInt(ee,10)}).filter(o=>!isNaN(o));console.log("Filtered currentYearIDs:",c);const d=c.length>0?Math.max(...c):0;console.log("Max number found:",d);const m=(d+1).toString().padStart(4,"0"),l=`SAF-${r}-${m}`;x({safetymanagementID:l,projectId:t}),w(!1),T(null),S(!0)},V=t=>{x({safetymanagementID:t.safety_report_id,incidentDate:t.incident_date,incidentDescription:t.incident_description,affectedpersonnelID:t.affected_personnel_id,injurySeverity:t.injury_severity,correctiveMeasures:t.corrective_measure,safetyTraining:t.safety_training_conducted}),M(t.project),J(t.safety_report_id),S(!0)},X=async t=>{if(window.confirm(`Are you sure you want to delete Safety ID: ${t}?`)){console.log("ðŸ†” Safety ID to delete:",t);try{await se(t),alert("âœ… Record deleted successfully"),F(),E(r=>r.filter(c=>c.safetyId!==t))}catch(r){console.error("âŒ Error deleting safety record:",r),alert("âŒ Failed to delete record")}}},f=()=>{S(!1),x({}),w(!1),T(null)},h=t=>{const{name:r,value:c}=t.target;x(d=>({...d,[r]:c}))},Z=async()=>{var t,r,c,d,D,m;try{const l={project:C,incident_date:i.incidentDate,incident_description:i.incidentDescription,affected_personnel_id:i.affectedpersonnelID,injury_severity:(t=i.injurySeverity)==null?void 0:t.toLowerCase(),corrective_measure:i.correctiveMeasures,safety_training_conducted:i.safetyTraining};let o;p?(o=await ie(p,l),alert(`âœï¸ Safety Management updated! Report ID: ${o.safety_report_id}`)):(o=await ae(l),alert(`âœ… Safety Management created! Report ID: ${o.safety_report_id}`)),f()}catch(l){const o=((c=(r=l.response)==null?void 0:r.data)==null?void 0:c.message)||((D=(d=l.response)==null?void 0:d.data)==null?void 0:D.detail)||"Something went wrong on the server.";alert(`âŒ Failed to save Safety Management record.

Error: ${o}`),console.error("âŒ Error saving Safety Management record:",((m=l.response)==null?void 0:m.data)||l.message)}};return H.filter(t=>Object.values(t).some(r=>r&&r.toString().toLowerCase().includes(b.toLowerCase()))),e.jsxs(e.Fragment,{children:[e.jsx(I,{variant:"h5",gutterBottom:!0,sx:{mt:5},children:"Safety Management"}),e.jsx(s,{container:!0,spacing:2,direction:"column",sx:{mb:2},children:e.jsx(s,{item:!0,xs:12,children:e.jsxs(A,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(I,{variant:"h6",gutterBottom:!0,children:"PROJECT RECORDS"}),e.jsx(N,{sx:{my:2,mx:1},children:e.jsx("input",{type:"text",placeholder:"Search Project ID",value:_,onChange:t=>$(t.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4}})}),e.jsxs(L,{children:[e.jsx(O,{children:e.jsxs(g,{children:[e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project ID"})}),e.jsx(n,{sx:{display:"flex",justifyContent:"flex-end",color:"#660000"},children:e.jsx("strong",{children:"Action"})})]})}),Q.filter(t=>String(t.id).toLowerCase().includes(_.toLowerCase())).map((t,r)=>e.jsxs(g,{children:[e.jsx(n,{children:t.project_id}),e.jsx(n,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(R,{slug:j,action:"can_create",children:e.jsx(u,{onClick:()=>K(t.project_id),color:"primary",children:e.jsx(he,{sx:{color:"#7267ef"}})})})})]},r))]})]})})}),e.jsx(s,{container:!0,spacing:2,children:e.jsx(s,{item:!0,xs:12,children:e.jsxs(A,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(I,{variant:"h6",gutterBottom:!0,children:"SAFETY MANAGEMENT DETAILS"}),e.jsx("input",{type:"text",placeholder:"Search Safety Management",value:b,onChange:t=>z(t.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4,marginBottom:"16px"}}),e.jsx(ue,{sx:{maxHeight:400,overflow:"auto",border:"1px solid #ddd"},children:e.jsxs(L,{stickyHeader:!0,children:[e.jsx(O,{children:e.jsxs(g,{children:[e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project ID"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Safety Report ID"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Incident Date"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Incident Description"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Affected Personnel ID"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Injury Severity"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Corrective Measures"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Safety Training Conducted"})}),e.jsx(n,{sx:{color:"#660000"},children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(xe,{children:v.map((t,r)=>e.jsxs(g,{children:[e.jsx(n,{children:t.project}),e.jsx(n,{children:t.safety_report_id}),e.jsx(n,{children:t.incident_date}),e.jsx(n,{children:t.incident_description}),e.jsx(n,{children:t.affected_personnel_id}),e.jsx(n,{children:t.injury_severity}),e.jsx(n,{children:t.corrective_measure}),e.jsx(n,{children:t.safety_training_conducted?"Yes":"No"}),e.jsxs(n,{children:[e.jsx(k,{slug:j,action:"can_update",children:e.jsx(u,{onClick:()=>V(t),color:"warning",children:e.jsx(je,{sx:{color:"orange"}})})}),e.jsx(R,{slug:j,action:"can_delete",children:e.jsx(u,{onClick:()=>X(t.safety_report_id),color:"error",children:e.jsx(pe,{sx:{color:"red"}})})})]})]},r))})]})})]})})}),e.jsxs(oe,{open:G,onClose:f,fullWidth:!0,maxWidth:"xl",PaperProps:{style:y?{width:"100%",height:"100vh",margin:0}:{width:"70%",height:"97vh"}},children:[e.jsx(ce,{children:U?"Edit Safety Management Details":"Enter Safety Management Details"}),e.jsxs(le,{sx:{position:"relative",overflowY:"auto"},children:[e.jsx(u,{"aria-label":"toggle-size",onClick:q,sx:{position:"absolute",right:40,top:8,color:t=>t.palette.grey[600]},children:y?e.jsx(fe,{}):e.jsx(me,{})}),e.jsx(u,{"aria-label":"close",onClick:f,sx:{position:"absolute",right:8,top:8,color:t=>t.palette.grey[500]},children:e.jsx(te,{})}),e.jsx(N,{component:"form",sx:{mt:2},children:e.jsxs(s,{container:!0,spacing:3,direction:"column",children:[e.jsxs(s,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Project Information"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"80%"}}),e.jsxs(s,{container:!0,spacing:2,children:[e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"projectId",children:"Project ID"}),e.jsx("input",{id:"projectId",className:"input",value:C,disabled:!0})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"safetymanagementID",children:"Safety Report ID"}),e.jsx("input",{id:"safetymanagementID",className:"input",value:i.safetymanagementID||"",disabled:!0})]})]})]}),e.jsxs(s,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Incident Information"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"80%"}}),e.jsxs(s,{container:!0,spacing:2,children:[e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"incidentDate",children:"Incident Date"}),e.jsx("input",{type:"date",id:"incidentDate",name:"incidentDate",className:"input",value:i.incidentDate||"",onChange:h})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"incidentDescription",children:"Incident Description"}),e.jsx("textarea",{rows:3,id:"incidentDescription",name:"incidentDescription",className:"input",value:i.incidentDescription||"",onChange:h})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"affectedpersonnelID",children:"Affected Personnel ID"}),e.jsx("input",{id:"affectedpersonnelID",name:"affectedpersonnelID",className:"input",value:i.affectedpersonnelID||"",onChange:h})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"injurySeverity",children:"Injury Severity"}),e.jsxs("select",{id:"injurySeverity",name:"injurySeverity",className:"input",value:i.injurySeverity||"",onChange:h,children:[e.jsx("option",{value:"",children:"Select Severity"}),e.jsx("option",{value:"Minor",children:"Minor"}),e.jsx("option",{value:"moerate",children:"Moderate"}),e.jsx("option",{value:"Severe",children:"Severe"}),e.jsx("option",{value:"Fatal",children:"Fatal"})]})]})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"correctiveMeasures",children:"Corrective Measures"}),e.jsx("input",{id:"correctiveMeasures",name:"correctiveMeasures",className:"input",value:i.correctiveMeasures||"",onChange:h})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"safetyTraining",children:"Safety Training Conducted"}),e.jsx("input",{type:"checkbox",id:"safetyTraining",name:"safetyTraining",checked:i.safetyTraining||!1,onChange:t=>x({...i,safetyTraining:t.target.checked})})]})]})]})})]}),e.jsxs(de,{children:[e.jsx(B,{onClick:f,sx:{outline:"2px solid #800000",color:"#800000","&:hover":{outline:"2px solid #b30000",color:"#b30000"}},children:"Cancel"}),e.jsx(k,{slug:j,action:p?"can_update":"can_create",children:e.jsx(B,{variant:"outlined",onClick:Z,sx:{borderColor:"#7267ef",color:"#7267ef","&:hover":{borderColor:"#9e8df2",color:"#9e8df2"}},children:p?"Update":"Submit"})})]})]})]})};export{Pe as default};
