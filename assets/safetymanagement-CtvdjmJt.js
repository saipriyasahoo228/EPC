import{r as a,j as e,T as _,J as R,E as k,S as A,I as p,K as Y}from"./main-Skim5IJC.js";import{C as ne}from"./Close-BKZ7QrSY.js";import{D as se}from"./Download-C4sxsXoP.js";import{E as oe,a as ae}from"./jspdf.plugin.autotable-Aj3tGQhx.js";import{g as ie}from"./engineering-BJ3wTiKO.js";import{s as ce,t as le,v as de,w as xe}from"./construction-CMO2W9OH.js";import{f as B}from"./date-DdrLtg20.js";import{G as s}from"./Grid-fY_ATwTx.js";import{T as z,a as L,b as S,c as n,d as he}from"./TableRow-B6k_bSOs.js";import{A as ue}from"./AddCircle-CJp4DZj3.js";import{B as I,D as pe,a as fe,b as je,c as me}from"./DialogTitle-CvDFHAwp.js";import{T as ge}from"./TableContainer-gCCy6yK7.js";import{E as ye}from"./Edit-6vcT2Cu4.js";import{D as Se}from"./Delete-Be1vvbhC.js";import{M as De,a as ve}from"./minimize-2-RCuvNn0X.js";const Le=()=>{const f="construction",[D,O]=a.useState(!1),[b,$]=a.useState(""),[C,G]=a.useState(""),[W,v]=a.useState(!1),[M,w]=a.useState(""),[o,h]=a.useState({}),[H,_e]=a.useState([]),[U,T]=a.useState(!1),[Ie,E]=a.useState(null),[J,Q]=a.useState([]),[j,F]=a.useState([]),[m,K]=a.useState(null),q=()=>{O(!D)};a.useEffect(()=>{(async()=>{try{const r=await ie();Q(r)}catch(r){console.error("Error fetching projects:",r)}})()},[]),a.useEffect(()=>{P()},[]);const P=async()=>{try{const t=await ce();F(t)}catch(t){console.error("❌ Error fetching safety records:",t)}},V=t=>{console.log("handleOpenForm called with projectId:",t),console.log("Current safetyRecords data:",j),w(t);const r=new Date().getFullYear(),c=j.filter(i=>i.safety_report_id&&i.safety_report_id.includes(`-${r}-`)).map(i=>{const N=i.safety_report_id.split("-"),re=N[N.length-1];return parseInt(re,10)}).filter(i=>!isNaN(i));console.log("Filtered currentYearIDs:",c);const d=c.length>0?Math.max(...c):0;console.log("Max number found:",d);const y=(d+1).toString().padStart(4,"0"),x=`SAF-${r}-${y}`;h({safetymanagementID:x,projectId:t}),T(!1),E(null),v(!0)},X=t=>{h({safetymanagementID:t.safety_report_id,incidentDate:t.incident_date,incidentDescription:t.incident_description,affectedpersonnelID:t.affected_personnel_id,injurySeverity:t.injury_severity,correctiveMeasures:t.corrective_measure,safetyTraining:t.safety_training_conducted}),w(t.project),K(t.safety_report_id),v(!0)},Z=async t=>{if(window.confirm(`Are you sure you want to delete Safety ID: ${t}?`)){console.log("🆔 Safety ID to delete:",t);try{await le(t),alert("✅ Record deleted successfully"),P(),F(r=>r.filter(c=>c.safetyId!==t))}catch(r){console.error("❌ Error deleting safety record:",r),alert("❌ Failed to delete record")}}},g=()=>{v(!1),h({}),T(!1),E(null)},u=t=>{const{name:r,value:c}=t.target;h(d=>({...d,[r]:c}))},ee=async()=>{var t,r,c,d,l,y;try{const x={project:M,incident_date:o.incidentDate,incident_description:o.incidentDescription,affected_personnel_id:o.affectedpersonnelID,injury_severity:(t=o.injurySeverity)==null?void 0:t.toLowerCase(),corrective_measure:o.correctiveMeasures,safety_training_conducted:o.safetyTraining};let i;m?(i=await de(m,x),alert(`✏️ Safety Management updated! Report ID: ${i.safety_report_id}`)):(i=await xe(x),alert(`✅ Safety Management created! Report ID: ${i.safety_report_id}`)),g()}catch(x){const i=((c=(r=x.response)==null?void 0:r.data)==null?void 0:c.message)||((l=(d=x.response)==null?void 0:d.data)==null?void 0:l.detail)||"Something went wrong on the server.";alert(`❌ Failed to save Safety Management record.

Error: ${i}`),console.error("❌ Error saving Safety Management record:",((y=x.response)==null?void 0:y.data)||x.message)}};H.filter(t=>Object.values(t).some(r=>r&&r.toString().toLowerCase().includes(C.toLowerCase())));const te=t=>{const r=new oe("l","mm","a4");r.setFontSize(16),r.text("All Safety Management Report",14,15);const c=["Project ID","Safety Report ID","Incident Date","Incident Description","Affected Personnel ID","Injury Severity","Corrective Measures","Safety Training Conducted"],d=t.map(l=>[l.project,l.safety_report_id,B(l.incident_date),l.incident_description,l.affected_personnel_id,l.injury_severity,l.corrective_measure,l.safety_training_conducted?"Yes":"No"]);ae(r,{head:[c],body:d,startY:25,styles:{fontSize:6,cellPadding:2,cellWidth:"auto",overflow:"linebreak"},headStyles:{fillColor:[114,103,239]},tableWidth:"auto"}),r.save("all_safety_management_report.pdf")};return e.jsxs(e.Fragment,{children:[e.jsx(_,{variant:"h5",gutterBottom:!0,sx:{mt:5},children:"Safety Management"}),e.jsx(s,{container:!0,spacing:2,direction:"column",sx:{mb:2},children:e.jsx(s,{item:!0,xs:12,children:e.jsxs(R,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(_,{variant:"h6",gutterBottom:!0,children:"PROJECT RECORDS"}),e.jsx(k,{sx:{my:2,mx:1},children:e.jsx("input",{type:"text",placeholder:"Search Project ID",value:b,onChange:t=>$(t.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4}})}),e.jsxs(z,{children:[e.jsx(L,{children:e.jsxs(S,{children:[e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project ID"})}),e.jsx(n,{sx:{display:"flex",justifyContent:"flex-end",color:"#660000"},children:e.jsx("strong",{children:"Action"})})]})}),J.filter(t=>String(t.id).toLowerCase().includes(b.toLowerCase())).map((t,r)=>e.jsxs(S,{children:[e.jsx(n,{children:t.project_id}),e.jsx(n,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(A,{slug:f,action:"can_create",children:e.jsx(p,{onClick:()=>V(t.project_id),color:"primary",children:e.jsx(ue,{sx:{color:"#7267ef"}})})})})]},r))]})]})})}),e.jsx(s,{container:!0,spacing:2,children:e.jsx(s,{item:!0,xs:12,children:e.jsxs(R,{sx:{p:2,backgroundColor:"#fff",border:"1px solid #ccc"},children:[e.jsx(I,{startIcon:e.jsx(se,{}),onClick:()=>te(j),children:"Download PDF"}),e.jsx(_,{variant:"h6",gutterBottom:!0,children:"SAFETY MANAGEMENT DETAILS"}),e.jsx("input",{type:"text",placeholder:"Search Safety Management",value:C,onChange:t=>G(t.target.value),className:"input",style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:4,marginBottom:"16px"}}),e.jsx(ge,{sx:{maxHeight:400,overflow:"auto",border:"1px solid #ddd"},children:e.jsxs(z,{stickyHeader:!0,children:[e.jsx(L,{children:e.jsxs(S,{children:[e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Project ID"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Safety Report ID"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Incident Date"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Incident Description"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Affected Personnel ID"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Injury Severity"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Corrective Measures"})}),e.jsx(n,{sx:{color:"#7267ef"},children:e.jsx("strong",{children:"Safety Training Conducted"})}),e.jsx(n,{sx:{color:"#660000"},children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(he,{children:j.map((t,r)=>e.jsxs(S,{children:[e.jsx(n,{children:t.project}),e.jsx(n,{children:t.safety_report_id}),e.jsx(n,{children:B(t.incident_date)}),e.jsx(n,{children:t.incident_description}),e.jsx(n,{children:t.affected_personnel_id}),e.jsx(n,{children:t.injury_severity}),e.jsx(n,{children:t.corrective_measure}),e.jsx(n,{children:t.safety_training_conducted?"Yes":"No"}),e.jsxs(n,{children:[e.jsx(Y,{slug:f,action:"can_update",children:e.jsx(p,{onClick:()=>X(t),color:"warning",children:e.jsx(ye,{sx:{color:"orange"}})})}),e.jsx(A,{slug:f,action:"can_delete",children:e.jsx(p,{onClick:()=>Z(t.safety_report_id),color:"error",children:e.jsx(Se,{sx:{color:"red"}})})})]})]},r))})]})})]})})}),e.jsxs(pe,{open:W,onClose:g,fullWidth:!0,maxWidth:"xl",PaperProps:{style:D?{width:"100%",height:"100vh",margin:0}:{width:"70%",height:"97vh"}},children:[e.jsx(fe,{children:U?"Edit Safety Management Details":"Enter Safety Management Details"}),e.jsxs(je,{sx:{position:"relative",overflowY:"auto"},children:[e.jsx(p,{"aria-label":"toggle-size",onClick:q,sx:{position:"absolute",right:40,top:8,color:t=>t.palette.grey[600]},children:D?e.jsx(De,{}):e.jsx(ve,{})}),e.jsx(p,{"aria-label":"close",onClick:g,sx:{position:"absolute",right:8,top:8,color:t=>t.palette.grey[500]},children:e.jsx(ne,{})}),e.jsx(k,{component:"form",sx:{mt:2},children:e.jsxs(s,{container:!0,spacing:3,direction:"column",children:[e.jsxs(s,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Project Information"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"80%"}}),e.jsxs(s,{container:!0,spacing:2,children:[e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"projectId",children:"Project ID"}),e.jsx("input",{id:"projectId",className:"input",value:M,disabled:!0})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"safetymanagementID",children:"Safety Report ID"}),e.jsx("input",{id:"safetymanagementID",className:"input",value:o.safetymanagementID||"",disabled:!0})]})]})]}),e.jsxs(s,{item:!0,xs:12,children:[e.jsx("h3",{style:{color:"#7267ef"},children:"Incident Information"}),e.jsx("hr",{style:{borderTop:"2px solid #7267ef",width:"80%"}}),e.jsxs(s,{container:!0,spacing:2,children:[e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"incidentDate",children:"Incident Date"}),e.jsx("input",{type:"date",id:"incidentDate",name:"incidentDate",className:"input",value:o.incidentDate||"",onChange:u})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"incidentDescription",children:"Incident Description"}),e.jsx("textarea",{rows:3,id:"incidentDescription",name:"incidentDescription",className:"input",value:o.incidentDescription||"",onChange:u})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"affectedpersonnelID",children:"Affected Personnel ID"}),e.jsx("input",{id:"affectedpersonnelID",name:"affectedpersonnelID",className:"input",value:o.affectedpersonnelID||"",onChange:u})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"injurySeverity",children:"Injury Severity"}),e.jsxs("select",{id:"injurySeverity",name:"injurySeverity",className:"input",value:o.injurySeverity||"",onChange:u,children:[e.jsx("option",{value:"",children:"Select Severity"}),e.jsx("option",{value:"Minor",children:"Minor"}),e.jsx("option",{value:"moerate",children:"Moderate"}),e.jsx("option",{value:"Severe",children:"Severe"}),e.jsx("option",{value:"Fatal",children:"Fatal"})]})]})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"correctiveMeasures",children:"Corrective Measures"}),e.jsx("input",{id:"correctiveMeasures",name:"correctiveMeasures",className:"input",value:o.correctiveMeasures||"",onChange:u})]}),e.jsxs(s,{item:!0,xs:6,children:[e.jsx("label",{htmlFor:"safetyTraining",children:"Safety Training Conducted"}),e.jsx("input",{type:"checkbox",id:"safetyTraining",name:"safetyTraining",checked:o.safetyTraining||!1,onChange:t=>h({...o,safetyTraining:t.target.checked})})]})]})]})})]}),e.jsxs(me,{children:[e.jsx(I,{onClick:g,sx:{outline:"2px solid #800000",color:"#800000","&:hover":{outline:"2px solid #b30000",color:"#b30000"}},children:"Cancel"}),e.jsx(Y,{slug:f,action:m?"can_update":"can_create",children:e.jsx(I,{variant:"outlined",onClick:ee,sx:{borderColor:"#7267ef",color:"#7267ef","&:hover":{borderColor:"#9e8df2",color:"#9e8df2"}},children:m?"Update":"Submit"})})]})]})]})};export{Le as default};
